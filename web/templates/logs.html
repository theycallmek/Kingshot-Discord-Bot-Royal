{% extends "base.html" %}

{% block title %}Logs - DOA Dashboard{% endblock %}

{% block content %}
<h1>Log Viewer</h1>
<div class="logs-container">
    <div class="log-section">
        <h2>Town Center</h2>
        <div class="sort-headers">
            <span class="sort-header" data-sort-by="change_date" data-table="furnace-logs" data-col="0">Date</span>
            <span class="sort-header" data-sort-by="fid" data-table="furnace-logs" data-col="1">FID</span>
            <span class="sort-header" data-sort-by="nickname" data-table="furnace-logs" data-col="2">Nickname</span>
            <span class="sort-header" data-sort-by="old_furnace_lv" data-table="furnace-logs" data-col="3">Old Value</span>
            <span class="sort-header" data-sort-by="new_furnace_lv" data-table="furnace-logs" data-col="4">New Value</span>
        </div>
        <table id="furnace-logs">
            <tbody>
                {% for log in furnace_changes %}
                <tr>
                    <td data-label="Date">{{ log.change_date }}</td>
                    <td data-label="FID">{{ log.fid }}</td>
                    <td data-label="Nickname">{{ user_map.get(log.fid, 'N/A') }}</td>
                    <td data-label="Old Value">{{ log.old_furnace_lv }}</td>
                    <td data-label="New Value">{{ log.new_furnace_lv }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="log-section">
        <h2>Nickname</h2>
        <div class="sort-headers">
            <span class="sort-header" data-sort-by="change_date" data-table="nickname-logs" data-col="0">Date</span>
            <span class="sort-header" data-sort-by="fid" data-table="nickname-logs" data-col="1">FID</span>
            <span class="sort-header" data-sort-by="old_nickname" data-table="nickname-logs" data-col="2">Old Value</span>
            <span class="sort-header" data-sort-by="new_nickname" data-table="nickname-logs" data-col="3">New Value</span>
        </div>
        <table id="nickname-logs">
            <tbody>
                {% for log in nickname_changes %}
                <tr>
                    <td data-label="Date">{{ log.change_date }}</td>
                    <td data-label="FID">{{ log.fid }}</td>
                    <td data-label="Old Value">{{ log.old_nickname }}</td>
                    <td data-label="New Value">{{ log.new_nickname }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const headers = document.querySelectorAll('.sort-header');
    const originalOrders = {};

    // Store original order for each table
    ['furnace-logs', 'nickname-logs'].forEach(tableId => {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        originalOrders[tableId] = Array.from(tbody.rows);
    });

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const sortBy = header.dataset.sortBy;
            const tableId = header.dataset.table;
            const colIndex = parseInt(header.dataset.col);
            let sortOrder = header.dataset.sortOrder || 'asc';

            if (sortOrder === 'asc') {
                header.dataset.sortOrder = 'desc';
            } else if (sortOrder === 'desc') {
                header.dataset.sortOrder = 'original';
            } else {
                header.dataset.sortOrder = 'asc';
            }

            sortRows(tableId, sortBy, header.dataset.sortOrder, colIndex);
        });
    });

    function sortRows(tableId, sortBy, order, colIndex) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);

        if (order === 'original') {
            originalOrders[tableId].forEach(row => tbody.appendChild(row));
            return;
        }

        rows.sort((a, b) => {
            let valA = a.cells[colIndex].textContent.trim();
            let valB = b.cells[colIndex].textContent.trim();

            if (sortBy === 'change_date') {
                valA = new Date(valA);
                valB = new Date(valB);
            } else if (!isNaN(valA) && !isNaN(valB)) {
                valA = Number(valA);
                valB = Number(valB);
            }

            if (valA < valB) {
                return order === 'asc' ? -1 : 1;
            }
            if (valA > valB) {
                return order === 'asc' ? 1 : -1;
            }
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
    }
});
</script>
{% endblock %}
