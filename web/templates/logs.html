{% extends "base.html" %}

{% block title %}Logs - DOA Dashboard{% endblock %}

{% block content %}
<h1>Log Viewer</h1>
<div class="logs-container">
    <div class="log-section">
        <h2 style="margin: 0 0 0.5rem 0;">Town Center</h2>
        <div style="display: flex; justify-content: flex-end; margin-bottom: 0.25rem;">
            <div class="sort-links">
                <span><strong>Sort:</strong></span>
                <a href="#" class="sort-link active tc-sort-date">Date ↓</a>
                <span>|</span>
                <a href="#" class="sort-link tc-sort-name">Name A-Z</a>
                <span>|</span>
                <a href="#" class="sort-link tc-sort-old">TC Old ↓</a>
                <span>|</span>
                <a href="#" class="sort-link tc-sort-new">TC New ↓</a>
            </div>
        </div>
        <table id="furnace-logs">
            <tbody>
                {% for log in furnace_changes %}
                <tr>
                    <td data-label="Date">{{ log.change_date }}</td>
                    <td data-label="FID">{{ log.fid }}</td>
                    <td data-label="Nickname">{{ user_map.get(log.fid, 'N/A') }}</td>
                    <td data-label="Old Value">{{ log.old_furnace_lv }}</td>
                    <td data-label="New Value">{{ log.new_furnace_lv }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="log-section">
        <h2 style="margin: 0 0 0.5rem 0;">Nickname</h2>
        <div style="display: flex; justify-content: flex-end; margin-bottom: 0.25rem;">
            <div class="sort-links">
                <span><strong>Sort:</strong></span>
                <a href="#" class="sort-link active nick-sort-date">Date ↓</a>
                <span>|</span>
                <a href="#" class="sort-link nick-sort-old">Old A-Z</a>
                <span>|</span>
                <a href="#" class="sort-link nick-sort-new">New A-Z</a>
            </div>
        </div>
        <table id="nickname-logs">
            <tbody>
                {% for log in nickname_changes %}
                <tr>
                    <td data-label="Date">{{ log.change_date }}</td>
                    <td data-label="FID">{{ log.fid }}</td>
                    <td data-label="Old Value">{{ log.old_nickname }}</td>
                    <td data-label="New Value">{{ log.new_nickname }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Town Center Logs sorting
    const tcSortDate = document.querySelector('.tc-sort-date');
    const tcSortName = document.querySelector('.tc-sort-name');
    const tcSortOld = document.querySelector('.tc-sort-old');
    const tcSortNew = document.querySelector('.tc-sort-new');
    const furnaceLogsTable = document.getElementById('furnace-logs');

    let tcDateAsc = false; // Default: newest first
    let tcNameAsc = true; // Default: A-Z
    let tcOldAsc = false; // Default: highest to lowest
    let tcNewAsc = false; // Default: highest to lowest

    tcSortDate.addEventListener('click', (e) => {
        e.preventDefault();
        tcDateAsc = !tcDateAsc;
        tcSortDate.textContent = tcDateAsc ? 'Date ↑' : 'Date ↓';

        tcSortDate.classList.add('active');
        tcSortName.classList.remove('active');
        tcSortOld.classList.remove('active');
        tcSortNew.classList.remove('active');

        sortTable(furnaceLogsTable, 0, tcDateAsc ? 'asc' : 'desc', 'date');
    });

    tcSortName.addEventListener('click', (e) => {
        e.preventDefault();
        tcNameAsc = !tcNameAsc;
        tcSortName.textContent = tcNameAsc ? 'Name A-Z' : 'Name Z-A';

        tcSortName.classList.add('active');
        tcSortDate.classList.remove('active');
        tcSortOld.classList.remove('active');
        tcSortNew.classList.remove('active');

        sortTable(furnaceLogsTable, 2, tcNameAsc ? 'asc' : 'desc', 'text');
    });

    tcSortOld.addEventListener('click', (e) => {
        e.preventDefault();
        tcOldAsc = !tcOldAsc;
        tcSortOld.textContent = tcOldAsc ? 'TC Old ↑' : 'TC Old ↓';

        tcSortOld.classList.add('active');
        tcSortDate.classList.remove('active');
        tcSortName.classList.remove('active');
        tcSortNew.classList.remove('active');

        sortTable(furnaceLogsTable, 3, tcOldAsc ? 'asc' : 'desc', 'number');
    });

    tcSortNew.addEventListener('click', (e) => {
        e.preventDefault();
        tcNewAsc = !tcNewAsc;
        tcSortNew.textContent = tcNewAsc ? 'TC New ↑' : 'TC New ↓';

        tcSortNew.classList.add('active');
        tcSortDate.classList.remove('active');
        tcSortName.classList.remove('active');
        tcSortOld.classList.remove('active');

        sortTable(furnaceLogsTable, 4, tcNewAsc ? 'asc' : 'desc', 'number');
    });

    // Nickname Logs sorting
    const nickSortDate = document.querySelector('.nick-sort-date');
    const nickSortOld = document.querySelector('.nick-sort-old');
    const nickSortNew = document.querySelector('.nick-sort-new');
    const nicknameLogsTable = document.getElementById('nickname-logs');

    let nickDateAsc = false; // Default: newest first
    let nickOldAsc = true; // Default: A-Z
    let nickNewAsc = true; // Default: A-Z

    nickSortDate.addEventListener('click', (e) => {
        e.preventDefault();
        nickDateAsc = !nickDateAsc;
        nickSortDate.textContent = nickDateAsc ? 'Date ↑' : 'Date ↓';

        nickSortDate.classList.add('active');
        nickSortOld.classList.remove('active');
        nickSortNew.classList.remove('active');

        sortTable(nicknameLogsTable, 0, nickDateAsc ? 'asc' : 'desc', 'date');
    });

    nickSortOld.addEventListener('click', (e) => {
        e.preventDefault();
        nickOldAsc = !nickOldAsc;
        nickSortOld.textContent = nickOldAsc ? 'Old A-Z' : 'Old Z-A';

        nickSortOld.classList.add('active');
        nickSortDate.classList.remove('active');
        nickSortNew.classList.remove('active');

        sortTable(nicknameLogsTable, 2, nickOldAsc ? 'asc' : 'desc', 'text');
    });

    nickSortNew.addEventListener('click', (e) => {
        e.preventDefault();
        nickNewAsc = !nickNewAsc;
        nickSortNew.textContent = nickNewAsc ? 'New A-Z' : 'New Z-A';

        nickSortNew.classList.add('active');
        nickSortDate.classList.remove('active');
        nickSortOld.classList.remove('active');

        sortTable(nicknameLogsTable, 3, nickNewAsc ? 'asc' : 'desc', 'text');
    });

    function sortTable(table, colIndex, order, type) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);

        rows.sort((a, b) => {
            let valA = a.cells[colIndex].textContent.trim();
            let valB = b.cells[colIndex].textContent.trim();

            if (type === 'date') {
                valA = new Date(valA);
                valB = new Date(valB);
            } else if (type === 'number') {
                valA = Number(valA);
                valB = Number(valB);
            } else {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }

            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Initial sort by date descending for both tables
    sortTable(furnaceLogsTable, 0, 'desc', 'date');
    sortTable(nicknameLogsTable, 0, 'desc', 'date');
});
</script>
{% endblock %}
