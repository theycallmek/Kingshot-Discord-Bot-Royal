{% extends "base.html" %}

{% block title %}Events Calendar - DOA Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<link rel="stylesheet" href="/static/dark-mode.css">
<style>
    .litepicker {
        z-index: 10000 !important;
    }

    /* vanilla-colorful theming for dark mode */
    hex-color-picker {
        width: 200px;
        height: 150px;
    }

    /* Dark mode styling using CSS Shadow Parts */
    body:not(.light-mode) hex-color-picker {
        --vcp-background: #1e1e1e;
        --vcp-border-color: #2c2c2c;
    }

    body:not(.light-mode) hex-color-picker::part(saturation) {
        border: 1px solid #2c2c2c;
        border-radius: 4px 4px 0 0;
    }

    body:not(.light-mode) hex-color-picker::part(hue) {
        border: 1px solid #2c2c2c;
        border-radius: 0 0 4px 4px;
        margin-top: 8px;
    }

    /* Color picker popup card - Centered overlay - HIDDEN by default */
    .color-picker-popup {
        position: fixed !important;
        background-color: #1e1e1e !important;
        border: 1px solid #2c2c2c !important;
        border-radius: 12px !important;
        padding: 15px !important;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.9) !important;
        z-index: 9999 !important;
        min-width: 280px !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        pointer-events: auto !important;
    }

    /* VISIBLE when active */
    .color-picker-popup.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        animation: popupFadeIn 0.15s ease-out;
        position: fixed !important;
        left: 50% !important;
        top: 50% !important;
        right: auto !important;
        bottom: auto !important;
        transform: translate(-50%, -50%) !important;
        margin: 0 !important;
    }

    /* Dark mode colors */
    body:not(.light-mode) .color-picker-popup {
        background-color: #1e1e1e !important;
        border-color: #2c2c2c !important;
    }

    /* Light mode colors */
    body.light-mode .color-picker-popup {
        background-color: #ffffff !important;
        border-color: #ddd !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
    }

    @keyframes popupFadeIn {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.95) !important;
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1) !important;
        }
    }

    /* Ensure active popup stays centered and on top */
    .color-picker-popup.active {
        z-index: 10000 !important;
    }

    /* Backdrop overlay for color picker */
    .color-picker-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        display: none;
    }

    .color-picker-backdrop.active {
        display: block !important;
    }

    /* Popup card header */
    .color-picker-popup-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--header-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: -15px -15px 15px -15px;
        padding: 0.75rem 1.5rem;
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .color-picker-popup-header span {
        flex: 1;
        font-weight: 300;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .color-picker-close-btn {
        background: none !important;
        border: none !important;
        color: var(--text-color) !important;
        font-size: 1.5rem !important;
        font-weight: bold !important;
        cursor: pointer !important;
        padding: 0 !important;
        margin: 0 !important;
        position: relative !important;
        display: inline-block !important;
        line-height: 1 !important;
    }

    .color-picker-close-btn:hover {
        color: var(--header-color) !important;
        background: none !important;
    }

    .color-picker-close-btn:focus {
        outline: none !important;
    }

    /* Hex input styling */
    .color-input-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
    }

    .color-input-container label {
        font-size: 12px;
        color: var(--text-color);
        min-width: 35px;
    }

    .color-input-container input {
        flex: 1;
        background-color: var(--background-color);
        border: 2px solid var(--border-color);
        color: var(--text-color);
        padding: 0.3rem;
        border-radius: 4px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        box-sizing: border-box;
    }

    .color-input-container input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(0, 168, 255, 0.2);
    }

    body.light-mode .color-input-container input {
        background-color: var(--background-color);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    .color-input-container input:focus {
        outline: none;
        border-color: #00a8ff;
    }
</style>
{% endblock %}

{% block content %}
<h1>Events Calendar</h1>

<div class="calendar">
    <div class="calendar-header" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;">
        <div class="timezone-controls" style="display: flex; align-items: center; gap: 0.4rem; justify-self: start;">
            <select id="timezone-select" style="padding: 0.25rem; border-radius: 4px; border: 2px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); font-size: 0.75rem;">
                <option value="UTC">UTC (Server Time)</option>
                <option value="America/New_York">Eastern Time (ET)</option>
                <option value="America/Chicago">Central Time (CT)</option>
                <option value="America/Denver">Mountain Time (MT)</option>
                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                <option value="America/Anchorage">Alaska Time (AKT)</option>
                <option value="Pacific/Honolulu">Hawaii Time (HT)</option>
                <option value="Europe/London">London (GMT/BST)</option>
                <option value="Europe/Paris">Central Europe (CET)</option>
                <option value="Europe/Athens">Eastern Europe (EET)</option>
                <option value="Asia/Dubai">Dubai (GST)</option>
                <option value="Asia/Shanghai">China (CST)</option>
                <option value="Asia/Tokyo">Japan (JST)</option>
                <option value="Australia/Sydney">Sydney (AEDT)</option>
            </select>
            <select id="time-format-select" style="padding: 0.25rem; border-radius: 4px; border: 2px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); font-size: 0.75rem;">
                <option value="24">24-Hour</option>
                <option value="12">12-Hour</option>
            </select>
        </div>
        <span class="month-name">{{ today.strftime('%B %Y') }}</span>
        <button id="add-event-btn" class="add-event-button" style="justify-self: end;">Add Event</button>
    </div>
    <div class="calendar-grid">
        <div class="day-name"><span class="full-day-name">Sunday</span><span class="short-day-name">Sun</span></div>
        <div class="day-name"><span class="full-day-name">Monday</span><span class="short-day-name">Mon</span></div>
        <div class="day-name"><span class="full-day-name">Tuesday</span><span class="short-day-name">Tue</span></div>
        <div class="day-name"><span class="full-day-name">Wednesday</span><span class="short-day-name">Wed</span></div>
        <div class="day-name"><span class="full-day-name">Thursday</span><span class="short-day-name">Thu</span></div>
        <div class="day-name"><span class="full-day-name">Friday</span><span class="short-day-name">Fri</span></div>
        <div class="day-name"><span class="full-day-name">Saturday</span><span class="short-day-name">Sat</span></div>

        {% for week in month_days %}
            {% for day in week %}
                <div class="day {% if day.month != today.month %}other-month{% endif %} {% if day == today %}today{% endif %}">
                    <div class="day-number">
                        {{ day.day }}
                    </div>
                    <div class="events">
                        {% if day in events_map %}
                            {% for event in events_map[day] %}
                                {% set background_style = '' %}
                                {% if event.embeds and event.embeds[0].thumbnail_url %}
                                    {% set url = event.embeds[0].thumbnail_url %}
                                    {% set background_style = "background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('" ~ url ~ "');" %}
                                {% endif %}
                                <div class="event {% if not event.is_enabled %}disabled{% endif %}" style="{{ background_style }} border-left-color: {{ ('#%06x'|format(event.embeds[0].color)) if event.embeds and event.embeds[0].color else 'var(--primary-color)' }};"
                                     data-event='{{ event.model_dump_json() | safe }}'
                                     data-utc-hour="{{ event.hour }}"
                                     data-utc-minute="{{ event.minute }}"
                                     data-utc-date="{{ event.next_notification.strftime('%Y-%m-%d') if event.next_notification else '' }}">
                                    <div class="event-header">
                                        <div class="event-time">{{ event.hour }}:{{ "%02d"|format(event.minute) }}</div>
                                        <div class="repeat-symbol {% if event.repeat_enabled %}repeat-green{% else %}repeat-red{% endif %}">‚Üª</div>
                                    </div>
                                    <div class="event-desc">{{ (event.embed_title[:-12] if event.embed_title.endswith('Notification') else event.embed_title)|trim }}</div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>

<!-- Edit Event Modal -->
<div id="edit-event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Edit Event</h2>
        <form id="edit-event-form">
            <input type="hidden" id="edit-event-id" name="id">

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="edit_message_type">Message Type:</label>
                    <select id="edit_message_type" name="message_type">
                        <option value="plain">Plain Message</option>
                        <option value="embed">Embed Message</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_channel_id">Channel:</label>
                    <select id="edit_channel_id" name="channel_id" required>
                        <option value="">-- Select Channel --</option>
                        <option value="1420123829484916867">üèÜÔΩúevents</option>
                        <option value="1420123824879308973">üêªÔΩúbear</option>
                        <option value="1420123828541198499">‚öîÔ∏èÔΩúarena</option>
                    </select>
                </div>
            </div>

            <div id="edit-plain-message-fields">
                <label for="edit_description">Description:</label>
                <input type="text" id="edit_description" name="description">
            </div>

            <div class="form-row" style="align-items: flex-end;">
                <!-- Left half -->
                <div style="flex: 1;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                        <div style="flex-basis: 46%;">
                            <label for="edit_next_notification_date">Date (UTC):</label>
                            <input type="text" id="edit_next_notification_date" name="next_notification_date" placeholder="Select Date..." style="width: 100%;">
                        </div>
                        <div style="flex-basis: 23%;">
                            <label for="edit_hour">Hour:</label>
                            <select id="edit_hour" name="hour" style="width: 100%;"></select>
                        </div>
                        <div style="flex-basis: 23%;">
                            <label for="edit_minute">Minute:</label>
                            <select id="edit_minute" name="minute" style="width: 100%;"></select>
                        </div>
                    </div>
                    <div style="margin-top: 3px; font-size: 0.7rem; color: var(--text-color); opacity: 0.8;">
                        <span>Local Time: </span>
                        <span id="edit_local_time_display" style="color: var(--primary-color);">--:--</span>
                    </div>
                </div>
                <!-- Right half -->
                <div style="flex: 1;">
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">
                        <div style="flex-grow: 1;">
                            <label for="edit_repeat_minutes">Repeat Interval:</label>
                            <select id="edit_repeat_minutes" name="repeat_minutes" style="width: 100%;">
                                <option value="0">No Repeat</option>
                                <option value="fixed">Specific Days</option>
                                {% for i in range(1, 15) %}
                                <option value="{{ i * 1440 }}">{{ i }} Day(s)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div style="padding-bottom: 8px;">
                            <label for="edit_is_enabled">Enabled:</label>
                            <input type="checkbox" id="edit_is_enabled" name="is_enabled" value="true">
                        </div>
                    </div>
                    <div style="margin-top: 3px; font-size: 0.7rem; color: var(--text-color); opacity: 0.8;">
                        <span id="edit_next_repeat_display">No Repeat</span>
                    </div>
                </div>
            </div>

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="edit_mention_type">Mention Type:</label>
                    <select id="edit_mention_type" name="mention_type">
                        <option value="none">None</option>
                        <option value="everyone">Everyone</option>
                        <option value="role_1420123834853490708">DOA Event üèÜ</option>
                        <option value="role_1420123831498178792">DOA Bear üêª</option>
                        <option value="role_1420839639136075796">doa Bear üêª</option>
                        <option value="role_1420839971400712213">doa Event üèÜ</option>
                        <option value="role_1420840300880068772">TFO Bear üêª</option>
                        <option value="role_1420840228209299519">TFO Event üèÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_notification_type">Notification Type:</label>
                    <select id="edit_notification_type" name="notification_type">
                        <option value="1">30m, 10m, 5m, 0m</option>
                        <option value="2">10m, 5m, 0m</option>
                        <option value="3">5m, 0m</option>
                        <option value="4">5m</option>
                        <option value="5">0m</option>
                        <option value="6">Custom Times</option>
                    </select>
                </div>
            </div>

            <div id="edit-custom-times-container" style="display: none;">
                <label for="edit_custom_times">Custom Times (e.g., 60-30-10-0):</label>
                <input type="text" id="edit_custom_times" name="custom_times">
            </div>

            <div id="edit-weekdays-container" style="display: none;">
                <label>Weekdays:</label>
                <div class="weekdays-checkboxes">
                    <input type="checkbox" name="weekdays" value="0"> Mon
                    <input type="checkbox" name="weekdays" value="1"> Tue
                    <input type="checkbox" name="weekdays" value="2"> Wed
                    <input type="checkbox" name="weekdays" value="3"> Thu
                    <input type="checkbox" name="weekdays" value="4"> Fri
                    <input type="checkbox" name="weekdays" value="5"> Sat
                    <input type="checkbox" name="weekdays" value="6"> Sun
                </div>
            </div>

            <div id="edit-embed-fields" style="display: none;">
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
                <label for="edit_embed_title">Title:</label>
                <input type="text" id="edit_embed_title" name="embed_title">
                <label for="edit_embed_description">Description:</label>
                <textarea id="edit_embed_description" name="embed_description" rows="3"></textarea>
                <label for="edit_embed_color">Color:</label>
                <div style="display: flex; align-items: center; gap: 10px; position: relative;">
                    <select id="edit_embed_color_select" style="flex: 1;">
                        <option value="#F94144">Red (#F94144)</option>
                        <option value="#F3722C">Orange Red (#F3722C)</option>
                        <option value="#F8961E">Orange (#F8961E)</option>
                        <option value="#F9844A">Light Orange (#F9844A)</option>
                        <option value="#F9C74F">Yellow (#F9C74F)</option>
                        <option value="#90BE6D">Green (#90BE6D)</option>
                        <option value="#43AA8B">Teal (#43AA8B)</option>
                        <option value="#4D908E">Blue Green (#4D908E)</option>
                        <option value="#577590">Blue Gray (#577590)</option>
                        <option value="#277DA1">Blue (#277DA1)</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="text" id="edit_embed_color" name="embed_color" style="display: none; flex: 1;">
                    <button type="button" id="edit_embed_color_picker_btn" style="width: 40px; height: 38px; border: 2px solid var(--border-color); border-radius: 4px; cursor: pointer; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.5rem; line-height: 1; font-weight: 600;">
                        <span style="display: none;">Pick</span>
                        <span style="display: none;">Color</span>
                    </button>
                </div>
                <label for="edit_embed_footer">Footer:</label>
                <input type="text" id="edit_embed_footer" name="embed_footer">
                <input type="hidden" id="edit_embed_author" name="embed_author">
                <label for="edit_embed_image_url">Image URL:</label>
                <input type="text" id="edit_embed_image_url" name="embed_image_url">
                <div class="thumbnail-container" style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                    <div class="thumbnail-selection" style="flex-grow: 1;">
                        <label for="edit_embed_thumbnail_url_select">Thumbnail:</label>
                        <select id="edit_embed_thumbnail_url_select" name="embed_thumbnail_url_select" class="thumbnail-select">
                            <option value="">None</option>
                            <option value="custom">Custom URL</option>
                        </select>
                        <div class="custom-thumbnail-container" style="display: none; margin-top: 10px;">
                            <label for="edit_embed_thumbnail_url">Custom Thumbnail URL:</label>
                            <input type="text" id="edit_embed_thumbnail_url" name="embed_thumbnail_url" class="custom-thumbnail-input">
                        </div>
                    </div>
                    <div class="thumbnail-preview-container">
                        <img id="edit-thumbnail-preview" class="thumbnail-preview" src="" alt="Thumbnail Preview" style="max-width: 75px; height: auto;">
                    </div>
                </div>
                <label for="edit_embed_mention_message">Mention Message:</label>
                <input type="text" id="edit_embed_mention_message" name="embed_mention_message">
            </div>

            <div class="modal-buttons">
                <button type="submit">Save</button>
                <button type="button" class="cancel-button">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Add New Event</h2>
        <form id="add-event-form">
            <input type="hidden" name="timezone" value="UTC">

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="add_message_type">Message Type:</label>
                    <select id="add_message_type" name="message_type">
                        <option value="plain">Plain Message</option>
                        <option value="embed" selected>Embed Message</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_channel_id">Channel:</label>
                    <select id="add_channel_id" name="channel_id" required>
                        <option value="1420123829484916867">üèÜÔΩúevents</option>
                        <option value="1420123824879308973">üêªÔΩúbear</option>
                        <option value="1420123828541198499">‚öîÔ∏èÔΩúarena</option>
                    </select>
                </div>
            </div>

            <div id="add-plain-message-fields">
                <label for="add_description">Description:</label>
                <input type="text" id="add_description" name="description">
            </div>

            <div class="form-row" style="align-items: flex-end;">
                <!-- Left half -->
                <div style="flex: 1;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                        <div style="flex-basis: 46%;">
                            <label for="add_next_notification_date">Date (UTC):</label>
                            <input type="text" id="add_next_notification_date" name="next_notification_date" required placeholder="Select Date..." style="width: 100%;">
                        </div>
                        <div style="flex-basis: 23%;">
                            <label for="add_hour">Hour:</label>
                            <select id="add_hour" name="hour" style="width: 100%;"></select>
                        </div>
                        <div style="flex-basis: 23%;">
                            <label for="add_minute">Minute:</label>
                            <select id="add_minute" name="minute" style="width: 100%;"></select>
                        </div>
                    </div>
                    <div style="margin-top: 3px; font-size: 0.7rem; color: var(--text-color); opacity: 0.8;">
                        <span>Local Time: </span>
                        <span id="add_local_time_display" style="color: var(--primary-color);">--:--</span>
                    </div>
                </div>
                <!-- Right half -->
                <div style="flex: 1;">
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">
                        <div style="flex-grow: 1;">
                            <label for="add_repeat_minutes">Repeat Interval:</label>
                            <select id="add_repeat_minutes" name="repeat_minutes" style="width: 100%;">
                                <option value="0">No Repeat</option>
                                <option value="fixed">Specific Days</option>
                                {% for i in range(1, 15) %}
                                <option value="{{ i * 1440 }}">{{ i }} Day(s)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div style="padding-bottom: 8px;">
                            <label for="add_is_enabled">Enabled:</label>
                            <input type="checkbox" id="add_is_enabled" name="is_enabled" value="true" checked>
                        </div>
                    </div>
                    <div style="margin-top: 3px; font-size: 0.7rem; color: var(--text-color); opacity: 0.8;">
                        <span id="add_next_repeat_display">No Repeat</span>
                    </div>
                </div>
            </div>

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="add_mention_type">Mention Type:</label>
                    <select id="add_mention_type" name="mention_type" required>
                        <option value="none" selected>None</option>
                        <option value="everyone">Everyone</option>
                        <option value="role_1420123834853490708">DOA Event üèÜ</option>
                        <option value="role_1420123831498178792">DOA Bear üêª</option>
                        <option value="role_1420839639136075796">doa Bear üêª</option>
                        <option value="role_1420839971400712213">doa Event üèÜ</option>
                        <option value="role_1420840300880068772">TFO Bear üêª</option>
                        <option value="role_1420840228209299519">TFO Event üèÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_notification_type">Notification Type:</label>
                    <select id="add_notification_type" name="notification_type">
                        <option value="1">30m, 10m, 5m, 0m</option>
                        <option value="2">10m, 5m, 0m</option>
                        <option value="3">5m, 0m</option>
                        <option value="4">5m</option>
                        <option value="5" selected>0m</option>
                        <option value="6">Custom Times</option>
                    </select>
                </div>
            </div>

            <div id="add-custom-times-container" style="display: none;">
                <label for="add_custom_times">Custom Times (e.g., 60-30-10-0):</label>
                <input type="text" id="add_custom_times" name="custom_times">
            </div>

            <div id="add-weekdays-container" style="display: none;">
                <label>Weekdays:</label>
                <div class="weekdays-checkboxes">
                    <input type="checkbox" name="weekdays" value="0"> Mon
                    <input type="checkbox" name="weekdays" value="1"> Tue
                    <input type="checkbox" name="weekdays" value="2"> Wed
                    <input type="checkbox" name="weekdays" value="3"> Thu
                    <input type="checkbox" name="weekdays" value="4"> Fri
                    <input type="checkbox" name="weekdays" value="5"> Sat
                    <input type="checkbox" name="weekdays" value="6"> Sun
                </div>
            </div>

            <div id="add-embed-fields" style="display: none;">
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
                <label for="add_embed_title">Title:</label>
                <input type="text" id="add_embed_title" name="embed_title">
                <label for="add_embed_description">Description:</label>
                <textarea id="add_embed_description" name="embed_description" rows="3"></textarea>
                <label for="add_embed_color">Color:</label>
                <div style="display: flex; align-items: center; gap: 10px; position: relative;">
                    <select id="add_embed_color_select" style="flex: 1;">
                        <option value="#F94144">Red (#F94144)</option>
                        <option value="#F3722C">Orange Red (#F3722C)</option>
                        <option value="#F8961E">Orange (#F8961E)</option>
                        <option value="#F9844A">Light Orange (#F9844A)</option>
                        <option value="#F9C74F">Yellow (#F9C74F)</option>
                        <option value="#90BE6D">Green (#90BE6D)</option>
                        <option value="#43AA8B">Teal (#43AA8B)</option>
                        <option value="#4D908E">Blue Green (#4D908E)</option>
                        <option value="#577590">Blue Gray (#577590)</option>
                        <option value="#277DA1">Blue (#277DA1)</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="text" id="add_embed_color" name="embed_color" style="display: none; flex: 1;">
                    <button type="button" id="add_embed_color_picker_btn" style="width: 40px; height: 38px; border: 2px solid var(--border-color); border-radius: 4px; cursor: pointer; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.5rem; line-height: 1; font-weight: 600;">
                        <span style="display: none;">Pick</span>
                        <span style="display: none;">Color</span>
                    </button>
                </div>
                <label for="add_embed_footer">Footer:</label>
                <input type="text" id="add_embed_footer" name="embed_footer" value="DOA Unified Notification System">
                <input type="hidden" id="add_embed_author" name="embed_author">
                <label for="add_embed_image_url">Image URL:</label>
                <input type="text" id="add_embed_image_url" name="embed_image_url">
                <div class="thumbnail-container" style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                    <div class="thumbnail-selection" style="flex-grow: 1;">
                        <label for="add_embed_thumbnail_url_select">Thumbnail:</label>
                        <select id="add_embed_thumbnail_url_select" name="embed_thumbnail_url_select" class="thumbnail-select">
                            <option value="">None</option>
                            <option value="custom">Custom URL</option>
                        </select>
                        <div class="custom-thumbnail-container" style="display: none; margin-top: 10px;">
                            <label for="add_embed_thumbnail_url">Custom Thumbnail URL:</label>
                            <input type="text" id="add_embed_thumbnail_url" name="embed_thumbnail_url" class="custom-thumbnail-input">
                        </div>
                    </div>
                    <div class="thumbnail-preview-container">
                        <img id="add-thumbnail-preview" class="thumbnail-preview" src="" alt="Thumbnail Preview" style="max-width: 75px; height: auto;">
                    </div>
                </div>
                <label for="add_embed_mention_message">Mention Message:</label>
                <input type="text" id="add_embed_mention_message" name="embed_mention_message">
            </div>

            <div class="modal-buttons">
                <button type="submit">Create</button>
                <button type="button" class="cancel-button">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Color Picker Popups (outside modals for proper overlay positioning) -->
<div id="edit_color_picker_backdrop" class="color-picker-backdrop"></div>
<div id="edit_color_picker_popup" class="color-picker-popup" style="display: none;">
    <div class="color-picker-popup-header">
        <span>Custom Color Picker</span>
        <button type="button" class="color-picker-close-btn" data-popup="edit_color_picker_popup" data-backdrop="edit_color_picker_backdrop">√ó</button>
    </div>
    <hex-color-picker id="edit_hex_picker" color="#F94144"></hex-color-picker>
    <div class="color-input-container">
        <label>Hex:</label>
        <input type="text" id="edit_hex_input" value="#F94144" maxlength="7" placeholder="#RRGGBB">
    </div>
</div>

<div id="add_color_picker_backdrop" class="color-picker-backdrop"></div>
<div id="add_color_picker_popup" class="color-picker-popup" style="display: none;">
    <div class="color-picker-popup-header">
        <span>Custom Color Picker</span>
        <button type="button" class="color-picker-close-btn" data-popup="add_color_picker_popup" data-backdrop="add_color_picker_backdrop">√ó</button>
    </div>
    <hex-color-picker id="add_hex_picker" color="#F94144"></hex-color-picker>
    <div class="color-input-container">
        <label>Hex:</label>
        <input type="text" id="add_hex_input" value="#F94144" maxlength="7" placeholder="#RRGGBB">
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script type="module">
    // Import vanilla-colorful web components
    import 'https://cdn.jsdelivr.net/npm/vanilla-colorful@0.7.2/hex-color-picker.js';
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    /* ===== VANILLA-COLORFUL CONFIGURATION =====
     * Library: vanilla-colorful v0.7.2
     * CDN: https://cdn.jsdelivr.net/npm/vanilla-colorful@0.7.2/hex-color-picker.js
     * HTML: <hex-color-picker color="#RRGGBB"></hex-color-picker>
     * Theming: CSS Shadow Parts (::part(saturation), ::part(hue))
     * ================================================= */

    // Load thumbnails dynamically from API
    const loadThumbnails = async () => {
        try {
            const response = await fetch('/api/thumbnails');
            const data = await response.json();

            // Get both thumbnail select elements
            const editSelect = document.getElementById('edit_embed_thumbnail_url_select');
            const addSelect = document.getElementById('add_embed_thumbnail_url_select');

            // Add thumbnails to both dropdowns
            data.thumbnails.forEach(thumbnail => {
                const editOption = document.createElement('option');
                editOption.value = thumbnail.url;
                editOption.textContent = thumbnail.filename;

                const addOption = document.createElement('option');
                addOption.value = thumbnail.url;
                addOption.textContent = thumbnail.filename;

                // Insert before "Custom URL" option
                editSelect.insertBefore(editOption, editSelect.querySelector('option[value="custom"]'));
                addSelect.insertBefore(addOption, addSelect.querySelector('option[value="custom"]'));
            });
        } catch (error) {
            console.error('Failed to load thumbnails:', error);
        }
    };

    // Load thumbnails on page load
    loadThumbnails();

    // ===== TIMEZONE AND TIME FORMAT MANAGEMENT =====
    const timezoneSelect = document.getElementById('timezone-select');
    const timeFormatSelect = document.getElementById('time-format-select');

    // Load saved timezone from localStorage or default to UTC
    const savedTimezone = localStorage.getItem('userTimezone') || 'UTC';
    timezoneSelect.value = savedTimezone;

    // Load saved time format from localStorage or default to 24-hour
    const savedTimeFormat = localStorage.getItem('userTimeFormat') || '24';
    timeFormatSelect.value = savedTimeFormat;

    // Save timezone to localStorage when changed
    timezoneSelect.addEventListener('change', (e) => {
        localStorage.setItem('userTimezone', e.target.value);
        updateAllLocalTimeDisplays();
        updateCalendarEventTimes();
    });

    // Save time format to localStorage when changed
    timeFormatSelect.addEventListener('change', (e) => {
        localStorage.setItem('userTimeFormat', e.target.value);
        updateAllLocalTimeDisplays();
        updateCalendarEventTimes();
    });

    // Function to convert UTC time to local timezone
    const convertUTCToLocal = (utcDateStr, utcHour, utcMinute, timezone, use12Hour = false) => {
        try {
            // Create a UTC date object
            const utcDate = new Date(`${utcDateStr}T${String(utcHour).padStart(2, '0')}:${String(utcMinute).padStart(2, '0')}:00Z`);

            // Format in the user's selected timezone
            const options = {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: use12Hour
            };

            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(utcDate);

            const dateParts = {};
            parts.forEach(part => {
                dateParts[part.type] = part.value;
            });

            // Build time string with AM/PM if 12-hour format
            let timeStr = `${dateParts.hour}:${dateParts.minute}`;
            if (use12Hour && dateParts.dayPeriod) {
                timeStr += ` ${dateParts.dayPeriod}`;
            }

            return {
                date: `${dateParts.year}-${dateParts.month}-${dateParts.day}`,
                time: timeStr,
                fullDateTime: `${dateParts.year}-${dateParts.month}-${dateParts.day} ${timeStr}`
            };
        } catch (error) {
            console.error('Error converting timezone:', error);
            return { date: utcDateStr, time: `${utcHour}:${utcMinute}`, fullDateTime: `${utcDateStr} ${utcHour}:${utcMinute}` };
        }
    };

    // Function to update local time display for a modal
    const updateLocalTimeDisplay = (modalPrefix) => {
        const dateInput = document.getElementById(`${modalPrefix}_next_notification_date`);
        const hourSelect = document.getElementById(`${modalPrefix}_hour`);
        const minuteSelect = document.getElementById(`${modalPrefix}_minute`);
        const display = document.getElementById(`${modalPrefix}_local_time_display`);

        if (!dateInput || !hourSelect || !minuteSelect || !display) return;

        const date = dateInput.value;
        const hour = parseInt(hourSelect.value);
        const minute = parseInt(minuteSelect.value);
        const timezone = timezoneSelect.value;
        const timeFormatSelect = document.getElementById('time-format-select');
        const use12Hour = timeFormatSelect ? timeFormatSelect.value === '12' : false;

        if (!date || isNaN(hour) || isNaN(minute)) {
            display.textContent = '--:--';
            return;
        }

        const localTime = convertUTCToLocal(date, hour, minute, timezone, use12Hour);
        const timezoneName = timezone === 'UTC' ? 'UTC' : timezone.split('/')[1].replace('_', ' ');
        display.textContent = `${localTime.fullDateTime} (${timezoneName})`;
    };

    // Function to update all local time displays
    const updateAllLocalTimeDisplays = () => {
        updateLocalTimeDisplay('edit');
        updateLocalTimeDisplay('add');
        updateNextRepeatDisplay('edit');
        updateNextRepeatDisplay('add');
    };

    // Function to calculate and display next repeat date
    const updateNextRepeatDisplay = (modalPrefix) => {
        const dateInput = document.getElementById(`${modalPrefix}_next_notification_date`);
        const hourSelect = document.getElementById(`${modalPrefix}_hour`);
        const minuteSelect = document.getElementById(`${modalPrefix}_minute`);
        const repeatSelect = document.getElementById(`${modalPrefix}_repeat_minutes`);
        const display = document.getElementById(`${modalPrefix}_next_repeat_display`);

        if (!dateInput || !repeatSelect || !display) return;

        const repeatValue = repeatSelect.value;
        const currentDate = dateInput.value;

        if (repeatValue === '0' || repeatValue === 'fixed') {
            display.innerHTML = repeatValue === '0' ? 'No Repeat' : 'Specific Days';
            return;
        }

        if (!currentDate) {
            display.innerHTML = 'No Repeat';
            return;
        }

        try {
            // Calculate next repeat date
            const repeatMinutes = parseInt(repeatValue);
            const repeatDays = repeatMinutes / 1440;
            const date = new Date(currentDate);
            date.setDate(date.getDate() + repeatDays);

            const nextDate = date.toISOString().split('T')[0];

            // Get hour and minute values (these are UTC)
            const hour = hourSelect ? hourSelect.value : '00';
            const minute = minuteSelect ? minuteSelect.value : '00';

            // Get time format preference
            const timeFormatSelect = document.getElementById('time-format-select');
            const use12Hour = timeFormatSelect ? timeFormatSelect.value === '12' : false;

            // Convert to user's selected timezone
            const timezone = timezoneSelect.value;
            if (timezone === 'UTC') {
                // Display UTC time directly (but still respect 12/24 hour format)
                if (use12Hour) {
                    const h = parseInt(hour);
                    const period = h >= 12 ? 'PM' : 'AM';
                    const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
                    const formattedDateTime = `${nextDate} ${displayHour}:${minute} ${period}`;
                    display.innerHTML = `Next: <span style="color: var(--primary-color);">${formattedDateTime}</span>`;
                } else {
                    const formattedDateTime = `${nextDate} ${hour}:${minute}`;
                    display.innerHTML = `Next: <span style="color: var(--primary-color);">${formattedDateTime}</span>`;
                }
            } else {
                // Convert UTC to local timezone
                const localTime = convertUTCToLocal(nextDate, parseInt(hour), parseInt(minute), timezone, use12Hour);
                display.innerHTML = `Next: <span style="color: var(--primary-color);">${localTime.fullDateTime}</span>`;
            }
        } catch (error) {
            display.innerHTML = 'No Repeat';
        }
    };

    // Function to update calendar event times based on selected timezone
    const updateCalendarEventTimes = () => {
        const timezone = timezoneSelect.value;
        const timeFormatSelect = document.getElementById('time-format-select');
        const use12Hour = timeFormatSelect ? timeFormatSelect.value === '12' : false;
        const allEvents = document.querySelectorAll('.event');

        allEvents.forEach(eventEl => {
            const utcHour = parseInt(eventEl.dataset.utcHour);
            const utcMinute = parseInt(eventEl.dataset.utcMinute);
            const utcDate = eventEl.dataset.utcDate;

            if (!isNaN(utcHour) && !isNaN(utcMinute) && utcDate) {
                const timeDisplay = eventEl.querySelector('.event-time');
                if (timeDisplay) {
                    if (timezone === 'UTC') {
                        // Show UTC time with selected format
                        if (use12Hour) {
                            const period = utcHour >= 12 ? 'PM' : 'AM';
                            const displayHour = utcHour === 0 ? 12 : utcHour > 12 ? utcHour - 12 : utcHour;
                            timeDisplay.textContent = `${displayHour}:${String(utcMinute).padStart(2, '0')} ${period}`;
                        } else {
                            timeDisplay.textContent = `${utcHour}:${String(utcMinute).padStart(2, '0')}`;
                        }
                    } else {
                        // Convert to local time
                        const localTime = convertUTCToLocal(utcDate, utcHour, utcMinute, timezone, use12Hour);
                        timeDisplay.textContent = localTime.time;
                    }
                }
            }
        });
    };

    // Update calendar event times on page load
    updateCalendarEventTimes();

    // Setup close buttons for color picker popups
    document.querySelectorAll('.color-picker-close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const popupId = e.target.dataset.popup;
            const backdropId = e.target.dataset.backdrop;
            const popup = document.getElementById(popupId);
            const backdrop = document.getElementById(backdropId);
            if (popup) {
                popup.classList.remove('active');
                popup.style.display = 'none';
                popup.style.visibility = 'hidden';
            }
            if (backdrop) {
                backdrop.classList.remove('active');
            }
        });
    });

    // Helper function to calculate luminance and determine text color
    const getContrastingTextColor = (hexColor) => {
        // Remove # if present
        const hex = hexColor.replace('#', '');
        // Convert to RGB
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        // Calculate luminance (perceived brightness)
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        // Return black for light colors, white for dark colors
        return luminance > 0.5 ? '#000000' : '#ffffff';
    };

    // Helper function to update button text visibility and color
    const updateButtonTextDisplay = (button, color, isCustom) => {
        const spans = button.querySelectorAll('span');
        spans.forEach(span => {
            span.style.display = isCustom ? 'block' : 'none';
            if (isCustom && color) {
                span.style.color = getContrastingTextColor(color);
            }
        });
    };

    // Wait for vanilla-colorful web components to be defined
    const setupColorPicker = async (selectId, textInputId, buttonId, popupId, pickerId, hexInputId, backdropId, defaultColor = '#F94144') => {
        // Wait for the web component to be defined
        await customElements.whenDefined('hex-color-picker');

        const select = document.getElementById(selectId);
        const textInput = document.getElementById(textInputId);
        const button = document.getElementById(buttonId);
        const popup = document.getElementById(popupId);
        const picker = document.getElementById(pickerId);
        const hexInput = document.getElementById(hexInputId);
        const backdrop = document.getElementById(backdropId);
        const closeBtn = popup.querySelector('.color-picker-close-btn');

        // Handle picker color change
        picker.addEventListener('color-changed', (e) => {
            const color = e.detail.value.toUpperCase();
            hexInput.value = color;
            textInput.value = color;
            button.style.backgroundColor = color;
            updateButtonTextDisplay(button, color, true);
        });

        // Handle hex input manual change
        hexInput.addEventListener('input', (e) => {
            let value = e.target.value.trim();
            if (!value.startsWith('#')) {
                value = '#' + value;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                const upperValue = value.toUpperCase();
                picker.color = upperValue;
                textInput.value = upperValue;
                button.style.backgroundColor = upperValue;
                updateButtonTextDisplay(button, upperValue, true);
            }
        });

        // Handle button click to toggle popup (ONLY when custom is selected)
        button.addEventListener('click', (e) => {
            console.log('Color picker button clicked!');
            if (select.value === 'custom') {
                const isActive = popup.classList.toggle('active');
                backdrop.classList.toggle('active');
                console.log('Popup active:', isActive);
                if (isActive) {
                    // Detect dark/light mode
                    const isDarkMode = !document.body.classList.contains('light-mode');
                    const bgColor = isDarkMode ? '#1e1e1e' : '#ffffff';
                    const borderColor = isDarkMode ? '#2c2c2c' : '#ddd';

                    // Show the popup - override ALL inline hiding styles
                    popup.style.setProperty('display', 'block', 'important');
                    popup.style.setProperty('visibility', 'visible', 'important');
                    popup.style.setProperty('opacity', '1', 'important');
                    // Force centered positioning
                    popup.style.setProperty('position', 'fixed', 'important');
                    popup.style.setProperty('left', '50%', 'important');
                    popup.style.setProperty('top', '50%', 'important');
                    popup.style.setProperty('transform', 'translate(-50%, -50%)', 'important');
                    popup.style.setProperty('right', 'auto', 'important');
                    popup.style.setProperty('bottom', 'auto', 'important');
                    popup.style.setProperty('z-index', '10000', 'important');
                    // Force background and border
                    popup.style.setProperty('background-color', bgColor, 'important');
                    popup.style.setProperty('border', `1px solid ${borderColor}`, 'important');
                    popup.style.setProperty('border-radius', '12px', 'important');
                    popup.style.setProperty('padding', '15px', 'important');
                    popup.style.setProperty('box-shadow', '0 12px 48px rgba(0, 0, 0, 0.9)', 'important');

                    // Style the close button to match modal close buttons
                    if (closeBtn) {
                        closeBtn.style.setProperty('background', 'none', 'important');
                        closeBtn.style.setProperty('background-color', 'transparent', 'important');
                        closeBtn.style.setProperty('border', 'none', 'important');
                        closeBtn.style.setProperty('box-shadow', 'none', 'important');
                        closeBtn.style.setProperty('color', 'var(--text-color)', 'important');
                        closeBtn.style.setProperty('font-size', '1.5rem', 'important');
                        closeBtn.style.setProperty('font-weight', 'bold', 'important');
                        closeBtn.style.setProperty('line-height', '1', 'important');
                        closeBtn.style.setProperty('cursor', 'pointer', 'important');
                        closeBtn.style.setProperty('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif", 'important');
                        closeBtn.style.setProperty('position', 'absolute', 'important');
                        closeBtn.style.setProperty('top', '0.5rem', 'important');
                        closeBtn.style.setProperty('right', '1rem', 'important');
                    }

                    // Style the hex-color-picker to be full width
                    if (picker) {
                        picker.style.setProperty('width', '100%', 'important');
                        picker.style.setProperty('height', '200px', 'important');
                    }

                    // Style the popup header to move title up
                    const popupHeader = popup.querySelector('.color-picker-popup-header');
                    if (popupHeader) {
                        popupHeader.style.setProperty('padding', '0.5rem', 'important');
                    }

                    // Style the hex input to match modal inputs
                    if (hexInput) {
                        const inputBgColor = isDarkMode ? '#1e1e1e' : '#ffffff';
                        const inputBorderColor = isDarkMode ? '#2c2c2c' : '#ddd';
                        const inputTextColor = isDarkMode ? '#e0e0e0' : '#333333';

                        hexInput.style.setProperty('background-color', inputBgColor, 'important');
                        hexInput.style.setProperty('border', `2px solid ${inputBorderColor}`, 'important');
                        hexInput.style.setProperty('color', inputTextColor, 'important');
                        hexInput.style.setProperty('padding', '0.3rem', 'important');
                        hexInput.style.setProperty('border-radius', '4px', 'important');
                        hexInput.style.setProperty('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif", 'important');
                        hexInput.style.setProperty('font-size', '14px', 'important');
                        hexInput.style.setProperty('box-sizing', 'border-box', 'important');
                    }

                    // Style the color input container to balance the layout
                    const inputContainer = hexInput.parentElement;
                    if (inputContainer && inputContainer.classList.contains('color-input-container')) {
                        inputContainer.style.setProperty('margin-top', '15px', 'important');
                        inputContainer.style.setProperty('justify-content', 'center', 'important');
                        inputContainer.style.setProperty('padding-left', '1rem', 'important');
                        inputContainer.style.setProperty('padding-right', '1rem', 'important');
                    }
                } else {
                    // Re-hide the popup
                    popup.style.setProperty('display', 'none', 'important');
                    popup.style.setProperty('visibility', 'hidden', 'important');
                }
                e.stopPropagation();
            }
        });

        // Handle dropdown change
        select.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                // Show text input and enable color picker button
                textInput.style.display = 'flex';
                button.style.pointerEvents = 'auto';
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                const currentColor = textInput.value || defaultColor;
                button.style.backgroundColor = currentColor;
                picker.color = currentColor;
                hexInput.value = currentColor;
                updateButtonTextDisplay(button, currentColor, true);
                // But keep popup hidden until button clicked
            } else {
                // Hide text input and disable color picker button
                textInput.style.display = 'none';
                textInput.value = e.target.value;
                button.style.backgroundColor = e.target.value;
                button.style.pointerEvents = 'none';
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                updateButtonTextDisplay(button, e.target.value, false);
                popup.classList.remove('active');
                backdrop.classList.remove('active');
                popup.style.display = 'none';
                popup.style.visibility = 'hidden';
            }
        });

        // Close popup when clicking backdrop
        backdrop.addEventListener('click', () => {
            popup.classList.remove('active');
            backdrop.classList.remove('active');
            popup.style.display = 'none';
            popup.style.visibility = 'hidden';
        });

        // Set initial button color based on current value
        const initialColor = textInput.value || defaultColor;
        button.style.backgroundColor = initialColor;
        picker.color = initialColor;
        hexInput.value = initialColor;

        // IMPORTANT: Always start with popup hidden
        popup.classList.remove('active');

        // Set dropdown to match initial color or custom
        const matchingOption = Array.from(select.options).find(opt => opt.value.toUpperCase() === initialColor.toUpperCase());
        if (matchingOption) {
            select.value = matchingOption.value;
            // Disable picker button for preset colors
            button.style.pointerEvents = 'none';
            button.style.opacity = '0.7';
            button.style.cursor = 'not-allowed';
            textInput.style.display = 'none';
            updateButtonTextDisplay(button, initialColor, false);
        } else {
            select.value = 'custom';
            textInput.style.display = 'flex';
            textInput.value = initialColor;
            // Enable picker button for custom colors
            button.style.pointerEvents = 'auto';
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            updateButtonTextDisplay(button, initialColor, true);
            // But keep popup hidden until user clicks button
        }
    };

    // Setup color pickers (async)
    setupColorPicker('edit_embed_color_select', 'edit_embed_color', 'edit_embed_color_picker_btn', 'edit_color_picker_popup', 'edit_hex_picker', 'edit_hex_input', 'edit_color_picker_backdrop');
    setupColorPicker('add_embed_color_select', 'add_embed_color', 'add_embed_color_picker_btn', 'add_color_picker_popup', 'add_hex_picker', 'add_hex_input', 'add_color_picker_backdrop');

    // Function to update event card overlays based on light/dark mode
    const updateEventOverlays = () => {
        const isLightMode = document.body.classList.contains('light-mode');
        const events = document.querySelectorAll('.event');

        events.forEach(event => {
            const style = event.getAttribute('style');
            if (style && style.includes('background-image')) {
                // Extract the URL from the style
                const urlMatch = style.match(/url\('([^']+)'\)/);
                if (urlMatch) {
                    const url = urlMatch[1];
                    let newStyle = style;

                    if (isLightMode) {
                        // Replace black gradient with white gradient for light mode
                        newStyle = newStyle.replace(
                            /linear-gradient\(rgba\(0,\s*0,\s*0,\s*[\d.]+\),\s*rgba\(0,\s*0,\s*0,\s*[\d.]+\)\)/,
                            'linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85))'
                        );
                    } else {
                        // Replace white gradient with black gradient for dark mode
                        newStyle = newStyle.replace(
                            /linear-gradient\(rgba\(255,\s*255,\s*255,\s*[\d.]+\),\s*rgba\(255,\s*255,\s*255,\s*[\d.]+\)\)/,
                            'linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7))'
                        );
                    }

                    event.setAttribute('style', newStyle);
                }
            }
        });
    };

    // Update overlays on page load
    updateEventOverlays();

    // Listen for theme toggle
    const themeToggle = document.querySelector('.theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            setTimeout(updateEventOverlays, 50); // Wait for theme class to be applied
        });
    }

    const editModal = document.getElementById('edit-event-modal');
    const addModal = document.getElementById('add-event-modal');
    const addEventBtn = document.getElementById('add-event-btn');

    const setupModal = (modal) => {
        const closeButton = modal.querySelector('.close-button');
        const cancelButton = modal.querySelector('.cancel-button');
        const selects = modal.querySelectorAll('select');
        const thumbnailSelect = modal.querySelector('.thumbnail-select');
        const customThumbnailInput = modal.querySelector('.custom-thumbnail-input');
        const thumbnailPreview = modal.querySelector('.thumbnail-preview');
        const dateInput = modal.querySelector('input[name="next_notification_date"]');
        const hourPicker = modal.querySelector('[name="hour"]');
        const minutePicker = modal.querySelector('[name="minute"]');
        modal.picker = null; // To hold the litepicker instance

        // Populate hour picker
        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            hourPicker.add(new Option(hour, hour));
        }

        // Populate minute picker
        for (let i = 0; i < 60; i++) {
            const minute = i.toString().padStart(2, '0');
            minutePicker.add(new Option(minute, minute));
        }

        const initLitepicker = (defaultDate) => {
            setTimeout(() => {
                if (modal.style.display !== 'block') return;
                if (modal.picker) modal.picker.destroy();
                modal.picker = new Litepicker({
                    element: dateInput,
                    parentEl: document.body,
                    format: 'YYYY-MM-DD',
                    autoApply: true,
                    singleMode: true,
                    showTooltip: false,
                });

                modal.picker.on('show', () => {
                    if (!document.body.classList.contains('light-mode')) {
                        const pickerEl = document.querySelector('.litepicker');
                        if (pickerEl) {
                            const darkTheme = {
                                '--litepicker-container-months-color-bg': '#1e1e1e',
                                '--litepicker-container-months-box-shadow-color': '#000',
                                '--litepicker-footer-color-bg': '#1e1e1e',
                                '--litepicker-footer-box-shadow-color': '#000',
                                '--litepicker-tooltip-color-bg': '#1e1e1e',
                                '--litepicker-month-header-color': '#e0e0e0',
                                '--litepicker-button-prev-month-color': '#e0e0e0',
                                '--litepicker-button-next-month-color': '#e0e0e0',
                                '--litepicker-button-prev-month-color-hover': '#00a8ff',
                                '--litepicker-button-next-month-color-hover': '#00a8ff',
                                '--litepicker-month-weekday-color': '#e0e0e0',
                                '--litepicker-month-week-number-color': '#e0e0e0',
                                '--litepicker-day-color': '#e0e0e0',
                                '--litepicker-day-color-hover': '#fff',
                                '--litepicker-is-today-color': '#fff',
                                '--litepicker-is-in-range-color': '#2a2a2a',
                                '--litepicker-is-locked-color': '#4a4a4a',
                                '--litepicker-is-start-color': '#fff',
                                '--litepicker-is-start-color-bg': '#00a8ff',
                                '--litepicker-is-end-color': '#fff',
                                '--litepicker-is-end-color-bg': '#00a8ff',
                                '--litepicker-button-cancel-color': '#e0e0e0',
                                '--litepicker-button-cancel-color-bg': '#2c2c2c',
                                '--litepicker-button-apply-color': '#fff',
                                '--litepicker-button-apply-color-bg': '#00a8ff',
                                '--litepicker-button-reset-color': '#e0e0e0',
                                '--litepicker-button-reset-color-hover': '#00a8ff',
                                '--litepicker-highlighted-day-color': '#1e1e1e',
                                '--litepicker-highlighted-day-color-bg': '#00a8ff',
                            };
                            for (const [key, value] of Object.entries(darkTheme)) {
                                pickerEl.style.setProperty(key, value);
                            }
                        }
                    }
                });

                if (defaultDate) {
                    modal.picker.setDate(defaultDate);
                }

                // Add listener for date change to update local time display
                modal.picker.on('selected', () => {
                    const modalPrefix = modal.id === 'edit-event-modal' ? 'edit' : 'add';
                    updateLocalTimeDisplay(modalPrefix);
                    updateNextRepeatDisplay(modalPrefix);
                });
            }, 0);
        };
        modal.initLitepicker = initLitepicker;

        // Add listeners to hour and minute pickers to update local time display and next repeat display
        const modalPrefix = modal.id === 'edit-event-modal' ? 'edit' : 'add';
        hourPicker.addEventListener('change', () => {
            updateLocalTimeDisplay(modalPrefix);
            updateNextRepeatDisplay(modalPrefix);
        });
        minutePicker.addEventListener('change', () => {
            updateLocalTimeDisplay(modalPrefix);
            updateNextRepeatDisplay(modalPrefix);
        });

        // Add listener to repeat interval dropdown to update next repeat display
        const repeatPicker = modal.querySelector('[name="repeat_minutes"]');
        if (repeatPicker) {
            repeatPicker.addEventListener('change', () => updateNextRepeatDisplay(modalPrefix));
        }


        const closeModal = () => {
            modal.style.display = 'none';
            if (modal.picker) {
                modal.picker.destroy();
                modal.picker = null;
            }
        };

        closeButton.addEventListener('click', closeModal);
        cancelButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) closeModal();
        });

        const updateThumbnailPreview = () => {
            if (!thumbnailSelect) return;
            const selectedValue = thumbnailSelect.value;
            const customValue = customThumbnailInput ? customThumbnailInput.value.trim() : '';
            let previewUrl = '';

            if (selectedValue === 'custom') {
                previewUrl = customValue;
            } else if (selectedValue) {
                previewUrl = selectedValue;
            }

            if (previewUrl && thumbnailPreview) {
                thumbnailPreview.src = previewUrl;
                thumbnailPreview.style.display = 'block';
            } else if (thumbnailPreview) {
                thumbnailPreview.style.display = 'none';
            }
        };

        const toggleFields = () => {
            const messageTypeSelect = modal.querySelector('select[name="message_type"]');
            if (messageTypeSelect) {
                const plainFields = modal.querySelector('[id$="-plain-message-fields"]');
                const embedFields = modal.querySelector('[id$="-embed-fields"]');
                const isEmbed = messageTypeSelect.value === 'embed';
                plainFields.style.display = isEmbed ? 'none' : 'block';
                embedFields.style.display = isEmbed ? 'block' : 'none';
            }

            const repeatMinutesSelect = modal.querySelector('select[name="repeat_minutes"]');
            if (repeatMinutesSelect) {
                const weekdaysContainer = modal.querySelector('[id$="-weekdays-container"]');
                if (weekdaysContainer) weekdaysContainer.style.display = repeatMinutesSelect.value === 'fixed' ? 'block' : 'none';
            }

            const notificationTypeSelect = modal.querySelector('select[name="notification_type"]');
            if (notificationTypeSelect) {
                const customTimesContainer = modal.querySelector('[id$="-custom-times-container"]');
                if(customTimesContainer) customTimesContainer.style.display = notificationTypeSelect.value === '6' ? 'block' : 'none';
            }

            if (thumbnailSelect) {
                const customThumbnailContainer = modal.querySelector('.custom-thumbnail-container');
                if (customThumbnailContainer) customThumbnailContainer.style.display = thumbnailSelect.value === 'custom' ? 'block' : 'none';
                updateThumbnailPreview();
            }
        };

        selects.forEach(select => select.addEventListener('change', toggleFields));
        if (customThumbnailInput) {
            customThumbnailInput.addEventListener('input', updateThumbnailPreview);
        }

        modal.toggleFields = toggleFields;
    };

    setupModal(editModal);
    setupModal(addModal);

    addEventBtn.addEventListener('click', () => {
        const form = document.getElementById('add-event-form');
        form.reset();
        addModal.style.display = 'block';
        addModal.toggleFields();
        const now = new Date();
        form.querySelector('[name="hour"]').value = now.getUTCHours().toString().padStart(2, '0');
        form.querySelector('[name="minute"]').value = now.getUTCMinutes().toString().padStart(2, '0');
        addModal.initLitepicker(now);

        // Update local time display and next repeat display after populating fields
        setTimeout(() => {
            updateLocalTimeDisplay('add');
            updateNextRepeatDisplay('add');
        }, 100);
    });

    document.querySelectorAll('.event').forEach(eventEl => {
        eventEl.addEventListener('click', () => {
            try {
                const rawEventData = eventEl.dataset.event;
                const eventData = JSON.parse(rawEventData);
                const form = document.getElementById('edit-event-form');

                // Populate main fields
                form.querySelector('#edit-event-id').value = eventData.id;
                form.querySelector('#edit_channel_id').value = eventData.channel_id;
                form.querySelector('#edit_repeat_minutes').value = eventData.repeat_minutes;
                form.querySelector('#edit_mention_type').value = eventData.mention_type;
                form.querySelector('#edit_notification_type').value = eventData.notification_type;
                form.querySelector('#edit_is_enabled').checked = eventData.is_enabled === 1;

                const nextNotification = new Date(eventData.next_notification);
                form.querySelector('[name="hour"]').value = nextNotification.getUTCHours().toString().padStart(2, '0');
                form.querySelector('[name="minute"]').value = nextNotification.getUTCMinutes().toString().padStart(2, '0');

                // Handle description and message type
                const messageTypeSelect = form.querySelector('#edit_message_type');
                let descriptionText = eventData.description || '';
                if (descriptionText.startsWith('CUSTOM_TIMES:')) {
                    const parts = descriptionText.split('|');
                    form.querySelector('#edit_custom_times').value = parts[0].replace('CUSTOM_TIMES:', '');
                    descriptionText = parts.length > 1 ? parts[1] : '';
                } else {
                    form.querySelector('#edit_custom_times').value = '';
                }

                if (descriptionText.startsWith('PLAIN_MESSAGE:')) {
                    messageTypeSelect.value = 'plain';
                    form.querySelector('#edit_description').value = descriptionText.replace('PLAIN_MESSAGE:', '');
                } else {
                    messageTypeSelect.value = 'embed';
                    form.querySelector('#edit_description').value = '';
                }

                // Populate embed fields
                const embed = eventData.embeds && eventData.embeds.length > 0 ? eventData.embeds[0] : {};
                form.querySelector('#edit_embed_title').value = embed.title || '';
                form.querySelector('#edit_embed_description').value = embed.description || '';
                const colorInput = form.querySelector('#edit_embed_color');
                const initialColor = embed.color ? `#${embed.color.toString(16).padStart(6, '0')}` : '#42445a';
                colorInput.value = initialColor;
                form.querySelector('#edit_embed_footer').value = embed.footer || '';
                form.querySelector('#edit_embed_author').value = embed.author || '';
                form.querySelector('#edit_embed_image_url').value = embed.image_url || '';
                form.querySelector('#edit_embed_mention_message').value = embed.mention_message || '';

                // Handle thumbnail
                const thumbnailSelect = form.querySelector('#edit_embed_thumbnail_url_select');
                const customThumbnailInput = form.querySelector('#edit_embed_thumbnail_url');
                const thumbnailUrl = embed.thumbnail_url || '';
                const isPreset = Array.from(thumbnailSelect.options).some(opt => opt.value === thumbnailUrl);

                if (isPreset) {
                    thumbnailSelect.value = thumbnailUrl;
                    if(customThumbnailInput) customThumbnailInput.value = '';
                } else if (thumbnailUrl) {
                    thumbnailSelect.value = 'custom';
                    if(customThumbnailInput) customThumbnailInput.value = thumbnailUrl;
                } else {
                    thumbnailSelect.value = '';
                    if(customThumbnailInput) customThumbnailInput.value = '';
                }

                // Handle weekdays
                const weekdays = eventData.notification_days ? eventData.notification_days.weekday.split('|').map(Number) : [];
                form.querySelectorAll('input[name="weekdays"]').forEach(checkbox => {
                    checkbox.checked = weekdays.includes(parseInt(checkbox.value));
                });
                
                editModal.style.display = 'block';
                editModal.toggleFields();
                editModal.initLitepicker(nextNotification);

                // Update local time display and next repeat display after populating fields
                setTimeout(() => {
                    updateLocalTimeDisplay('edit');
                    updateNextRepeatDisplay('edit');
                }, 100);

            } catch (e) {
                console.error("Error parsing event data or displaying modal:", e);
            }
        });
    });

    const submitForm = async (form, url) => {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Handle thumbnail URL
        const thumbnailSelect = form.querySelector('.thumbnail-select');
        if (thumbnailSelect && thumbnailSelect.value !== 'custom') {
            data.embed_thumbnail_url = thumbnailSelect.value;
        }
        delete data.embed_thumbnail_url_select;

        // Validation and type conversion
        if (!data.channel_id) {
            alert("Error: Please select a channel for the event.");
            return;
        }

        if (data.next_notification_date && data.hour && data.minute) {
            const date = new Date(`${data.next_notification_date}T${data.hour}:${data.minute}:00Z`);
            data.hour = date.getUTCHours();
            data.minute = date.getUTCMinutes();
            data.next_notification = date.toISOString();
        }
        delete data.next_notification_date;

        if (data.id) data.id = parseInt(data.id);
        data.notification_type = parseInt(data.notification_type);
        data.is_enabled = form.querySelector('input[name="is_enabled"]').checked;

        if (data.repeat_minutes === 'fixed') {
            data.weekdays = Array.from(form.querySelectorAll('input[name="weekdays"]:checked')).map(cb => parseInt(cb.value));
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorText = await response.text();
                try {
                    const error = JSON.parse(errorText);
                    const errorMessage = error.detail ? JSON.stringify(error.detail) : 'Unknown error';
                    alert(`Failed to save event: ${errorMessage}`);
                } catch (e) {
                    alert(`Failed to save event: ${errorText}`);
                }
            }
        } catch (error) {
            alert(`Failed to save event: An unexpected error occurred.`);
            console.error('Submit error:', error);
        }
    };

    document.getElementById('edit-event-form').addEventListener('submit', (e) => {
        e.preventDefault();
        submitForm(e.target, '/update_event');
    });

    document.getElementById('add-event-form').addEventListener('submit', (e) => {
        e.preventDefault();
        submitForm(e.target, '/create_event');
    });
});
</script>
{% endblock %}