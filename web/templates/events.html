{% extends "base.html" %}

{% block title %}Events Calendar - Kingshot Bot{% endblock %}

{% block content %}
<h1>Events Calendar</h1>
<div class="calendar">
    <div class="calendar-header">
        <span class="month-name">{{ today.strftime('%B %Y') }}</span>
    </div>
    <div class="calendar-grid">
        <div class="day-name">Sun</div>
        <div class="day-name">Mon</div>
        <div class="day-name">Tue</div>
        <div class="day-name">Wed</div>
        <div class="day-name">Thu</div>
        <div class="day-name">Fri</div>
        <div class="day-name">Sat</div>

        {% for week in month_days %}
            {% for day in week %}
                <div class="day {% if day.month != today.month %}other-month{% endif %} {% if day == today %}today{% endif %}">
                    <div class="day-number">{{ day.day }}</div>
                    <div class="events">
                        {% if day in events_map %}
                            {% for event in events_map[day] %}
                                <div class="event" style="{% if event.embeds and event.embeds[0].thumbnail_url %}background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{{ event.embeds[0].thumbnail_url }}');{% endif %} border-left-color: {{ event.embeds[0].color if event.embeds else 'var(--primary-color)' }};"
                                     data-event='{{ event.model_dump_json() }}'>
                                    <div class="event-time">{{ event.hour }}:{{ "%02d"|format(event.minute) }}</div>
                                    <div class="event-desc">{{ event.embed_title }}</div>
                                    <div class="event-details">
                                        {{ event.created_by_nickname }}<br>
                                        <strong>Repeats:</strong> {% if event.repeat_enabled %}Yes{% else %}No{% endif %}<br>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>

<div id="edit-event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Edit Event</h2>
        <form id="edit-event-form">
            <input type="hidden" id="event-id" name="id">

            <label for="description">Description:</label>
            <input type="text" id="description" name="description">

            <label for="channel_id">Channel ID:</label>
            <input type="text" id="channel_id" name="channel_id">

            <label for="hour">Hour:</label>
            <input type="number" id="hour" name="hour" min="0" max="23">

            <label for="minute">Minute:</label>
            <input type="number" id="minute" name="minute" min="0" max="59">

            <label for="repeat_enabled">Enable Repeats:</label>
            <input type="checkbox" id="repeat_enabled" name="repeat_enabled">

            <div id="repeat-options" style="display: none;">
                <label for="repeat_minutes">Repeat Interval:</label>
                <input type="text" id="repeat_minutes" name="repeat_minutes">
            </div>

            <label for="mention_type">Mention Type:</label>
            <input type="text" id="mention_type" name="mention_type">

            <label for="notification_type">Notification Type:</label>
            <input type="number" id="notification_type" name="notification_type">

            <label for="next_notification">Next Notification:</label>
            <input type="datetime-local" id="next_notification" name="next_notification">

            <div id="weekdays-container" style="display: none;">
                <label>Weekdays:</label>
                <div class="weekdays-checkboxes">
                    <input type="checkbox" name="weekdays" value="0"> Mon
                    <input type="checkbox" name="weekdays" value="1"> Tue
                    <input type="checkbox" name="weekdays" value="2"> Wed
                    <input type="checkbox" name="weekdays" value="3"> Thu
                    <input type="checkbox" name="weekdays" value="4"> Fri
                    <input type="checkbox" name="weekdays" value="5"> Sat
                    <input type="checkbox" name="weekdays" value="6"> Sun
                </div>
            </div>

            <hr>
            <h3>Embed Details</h3>

            <label for="embed_title">Title:</label>
            <input type="text" id="embed_title" name="embed_title">

            <label for="embed_description">Description:</label>
            <textarea id="embed_description" name="embed_description" rows="3"></textarea>

            <label for="embed_color">Color:</label>
            <input type="text" id="embed_color" name="embed_color">

            <label for="embed_footer">Footer:</label>
            <input type="text" id="embed_footer" name="embed_footer">

            <label for="embed_author">Author:</label>
            <input type="text" id="embed_author" name="embed_author">

            <label for="embed_image_url">Image URL:</label>
            <input type="text" id="embed_image_url" name="embed_image_url">

            <label for="embed_thumbnail_url">Thumbnail URL:</label>
            <input type="text" id="embed_thumbnail_url" name="embed_thumbnail_url">

            <label for="embed_mention_message">Mention Message:</label>
            <input type="text" id="embed_mention_message" name="embed_mention_message">


            <div class="modal-buttons">
                <button type="submit">Save</button>
                <button type="button" id="cancel-button">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('edit-event-modal');
    const closeButton = document.querySelector('.close-button');
    const cancelButton = document.getElementById('cancel-button');
    const form = document.getElementById('edit-event-form');
    const weekdaysContainer = document.getElementById('weekdays-container');
    const repeatOptions = document.getElementById('repeat-options');
    const repeatEnabledCheckbox = document.getElementById('repeat_enabled');

    document.querySelectorAll('.event').forEach(eventEl => {
        eventEl.addEventListener('click', () => {
            const eventData = JSON.parse(eventEl.dataset.event);

            form.id.value = eventData.id;
            form.description.value = eventData.description;
            form.channel_id.value = eventData.channel_id;
            form.hour.value = eventData.hour;
            form.minute.value = eventData.minute;
            form.repeat_minutes.value = eventData.repeat_minutes;
            form.mention_type.value = eventData.mention_type;
            form.notification_type.value = eventData.notification_type;
            form.next_notification.value = eventData.next_notification ? eventData.next_notification.slice(0, 16) : '';
            repeatEnabledCheckbox.checked = eventData.repeat_enabled;

            if (eventData.embeds && eventData.embeds.length > 0) {
                const embed = eventData.embeds[0];
                form.embed_title.value = embed.title;
                form.embed_description.value = embed.description;
                form.embed_color.value = embed.color ? `#${embed.color.toString(16).padStart(6, '0')}` : '';
                form.embed_footer.value = embed.footer;
                form.embed_author.value = embed.author;
                form.embed_image_url.value = embed.image_url;
                form.embed_thumbnail_url.value = embed.thumbnail_url;
                form.embed_mention_message.value = embed.mention_message;
            }

            const toggleRepeatOptions = () => {
                if (repeatEnabledCheckbox.checked) {
                    repeatOptions.style.display = 'block';
                    if (form.repeat_minutes.value === 'fixed') {
                        weekdaysContainer.style.display = 'block';
                    } else {
                        weekdaysContainer.style.display = 'none';
                    }
                } else {
                    repeatOptions.style.display = 'none';
                    weekdaysContainer.style.display = 'none';
                }
            };

            toggleRepeatOptions(); // Initial check
            repeatEnabledCheckbox.addEventListener('change', toggleRepeatOptions);


            const weekdays = eventData.notification_days ? eventData.notification_days.weekday.split('|').map(Number) : [];
            form.querySelectorAll('input[name="weekdays"]').forEach(checkbox => {
                checkbox.checked = weekdays.includes(parseInt(checkbox.value));
            });

            modal.style.display = 'block';
        });
    });

    const closeModal = () => {
        modal.style.display = 'none';
    };

    closeButton.addEventListener('click', closeModal);
    cancelButton.addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            closeModal();
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.id = parseInt(data.id);
        data.channel_id = parseInt(data.channel_id);
        data.hour = parseInt(data.hour);
        data.minute = parseInt(data.minute);
        data.notification_type = parseInt(data.notification_type);
        data.next_notification = new Date(data.next_notification).toISOString();
        data.repeat_enabled = repeatEnabledCheckbox.checked;

        if (!data.repeat_enabled) {
            data.repeat_minutes = "";
        }

        if (data.repeat_minutes === 'fixed') {
            data.weekdays = Array.from(form.querySelectorAll('input[name="weekdays"]:checked')).map(cb => parseInt(cb.value));
        }

        const response = await fetch('/update_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            closeModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Failed to save event: ' + (error.error || 'Unknown error'));
        }
    });

    document.getElementById('repeat_minutes').addEventListener('input', (e) => {
        if (repeatEnabledCheckbox.checked && e.target.value === 'fixed') {
            weekdaysContainer.style.display = 'block';
        } else {
            weekdaysContainer.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
