{% extends "base.html" %}

{% block title %}Events Calendar - DOA Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-picker@2/dist/vanilla-picker.min.css"/>
<link rel="stylesheet" href="/static/dark-mode.css">
<style>
    .litepicker {
        z-index: 10000 !important;
    }
    /* Vanilla Picker styling */
    .picker_wrapper {
        z-index: 100000 !important;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Events Calendar</h1>
</div>

<div class="calendar">
    <div class="calendar-header">
        <span class="month-name">{{ today.strftime('%B %Y') }}</span>
        <button id="add-event-btn" class="add-event-button">Add Event</button>
    </div>
    <div class="calendar-grid">
        <div class="day-name"><span class="full-day-name">Sunday</span><span class="short-day-name">Sun</span></div>
        <div class="day-name"><span class="full-day-name">Monday</span><span class="short-day-name">Mon</span></div>
        <div class="day-name"><span class="full-day-name">Tuesday</span><span class="short-day-name">Tue</span></div>
        <div class="day-name"><span class="full-day-name">Wednesday</span><span class="short-day-name">Wed</span></div>
        <div class="day-name"><span class="full-day-name">Thursday</span><span class="short-day-name">Thu</span></div>
        <div class="day-name"><span class="full-day-name">Friday</span><span class="short-day-name">Fri</span></div>
        <div class="day-name"><span class="full-day-name">Saturday</span><span class="short-day-name">Sat</span></div>

        {% for week in month_days %}
            {% for day in week %}
                <div class="day {% if day.month != today.month %}other-month{% endif %} {% if day == today %}today{% endif %}">
                    <div class="day-number">
                        {{ day.day }}
                    </div>
                    <div class="events">
                        {% if day in events_map %}
                            {% for event in events_map[day] %}
                                {% set background_style = '' %}
                                {% if event.embeds and event.embeds[0].thumbnail_url %}
                                    {% set url = event.embeds[0].thumbnail_url %}
                                    {% set background_style = "background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('" ~ url ~ "');" %}
                                {% endif %}
                                <div class="event {% if not event.is_enabled %}disabled{% endif %}" style="{{ background_style }} border-left-color: {{ ('#%06x'|format(event.embeds[0].color)) if event.embeds and event.embeds[0].color else 'var(--primary-color)' }};"
                                     data-event='{{ event.model_dump_json() | safe }}'>
                                    <div class="event-header">
                                        <div class="event-time">{{ event.hour }}:{{ "%02d"|format(event.minute) }}</div>
                                        <div class="repeat-symbol {% if event.repeat_enabled %}repeat-green{% else %}repeat-red{% endif %}">‚Üª</div>
                                    </div>
                                    <div class="event-desc">{{ (event.embed_title[:-12] if event.embed_title.endswith('Notification') else event.embed_title)|trim }}</div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>

<!-- Edit Event Modal -->
<div id="edit-event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Edit Event</h2>
        <form id="edit-event-form">
            <input type="hidden" id="edit-event-id" name="id">

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="edit_message_type">Message Type:</label>
                    <select id="edit_message_type" name="message_type">
                        <option value="plain">Plain Message</option>
                        <option value="embed">Embed Message</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_channel_id">Channel:</label>
                    <select id="edit_channel_id" name="channel_id" required>
                        <option value="">-- Select Channel --</option>
                        <option value="1420123829484916867">üèÜÔΩúevents</option>
                        <option value="1420123824879308973">üêªÔΩúbear</option>
                        <option value="1420123828541198499">‚öîÔ∏èÔΩúarena</option>
                    </select>
                </div>
            </div>

            <div id="edit-plain-message-fields">
                <label for="edit_description">Description:</label>
                <input type="text" id="edit_description" name="description">
            </div>

            <div class="form-row" style="align-items: flex-end;">
                <!-- Left half -->
                <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                    <div style="flex-basis: 46%;">
                        <label for="edit_next_notification_date">Date (UTC):</label>
                        <input type="text" id="edit_next_notification_date" name="next_notification_date" placeholder="Select Date..." style="width: 100%;">
                    </div>
                    <div style="flex-basis: 23%;">
                        <label for="edit_hour">Hour:</label>
                        <select id="edit_hour" name="hour" style="width: 100%;"></select>
                    </div>
                    <div style="flex-basis: 23%;">
                        <label for="edit_minute">Minute:</label>
                        <select id="edit_minute" name="minute" style="width: 100%;"></select>
                    </div>
                </div>
                <!-- Right half -->
                <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">
                    <div style="flex-grow: 1;">
                        <label for="edit_repeat_minutes">Repeat Interval:</label>
                        <select id="edit_repeat_minutes" name="repeat_minutes" style="width: 100%;">
                            <option value="0">No Repeat</option>
                            <option value="fixed">Specific Days</option>
                            {% for i in range(1, 15) %}
                            <option value="{{ i * 1440 }}">{{ i }} Day(s)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="padding-bottom: 8px;">
                        <label for="edit_is_enabled">Enabled:</label>
                        <input type="checkbox" id="edit_is_enabled" name="is_enabled" value="true">
                    </div>
                </div>
            </div>

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="edit_mention_type">Mention Type:</label>
                    <select id="edit_mention_type" name="mention_type">
                        <option value="none">None</option>
                        <option value="everyone">Everyone</option>
                        <option value="role_1420123834853490708">DOA Event üèÜ</option>
                        <option value="role_1420123831498178792">DOA Bear üêª</option>
                        <option value="role_1420839639136075796">doa Bear üêª</option>
                        <option value="role_1420839971400712213">doa Event üèÜ</option>
                        <option value="role_1420840300880068772">TFO Bear üêª</option>
                        <option value="role_1420840228209299519">TFO Event üèÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_notification_type">Notification Type:</label>
                    <select id="edit_notification_type" name="notification_type">
                        <option value="1">30m, 10m, 5m, 0m</option>
                        <option value="2">10m, 5m, 0m</option>
                        <option value="3">5m, 0m</option>
                        <option value="4">5m</option>
                        <option value="5">0m</option>
                        <option value="6">Custom Times</option>
                    </select>
                </div>
            </div>

            <div id="edit-custom-times-container" style="display: none;">
                <label for="edit_custom_times">Custom Times (e.g., 60-30-10-0):</label>
                <input type="text" id="edit_custom_times" name="custom_times">
            </div>

            <div id="edit-weekdays-container" style="display: none;">
                <label>Weekdays:</label>
                <div class="weekdays-checkboxes">
                    <input type="checkbox" name="weekdays" value="0"> Mon
                    <input type="checkbox" name="weekdays" value="1"> Tue
                    <input type="checkbox" name="weekdays" value="2"> Wed
                    <input type="checkbox" name="weekdays" value="3"> Thu
                    <input type="checkbox" name="weekdays" value="4"> Fri
                    <input type="checkbox" name="weekdays" value="5"> Sat
                    <input type="checkbox" name="weekdays" value="6"> Sun
                </div>
            </div>

            <div id="edit-embed-fields" style="display: none;">
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
                <label for="edit_embed_title">Title:</label>
                <input type="text" id="edit_embed_title" name="embed_title">
                <label for="edit_embed_description">Description:</label>
                <textarea id="edit_embed_description" name="embed_description" rows="3"></textarea>
                <label for="edit_embed_color">Color:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="edit_embed_color_select" style="flex: 1;">
                        <option value="#F94144">Red (#F94144)</option>
                        <option value="#F3722C">Orange Red (#F3722C)</option>
                        <option value="#F8961E">Orange (#F8961E)</option>
                        <option value="#F9844A">Light Orange (#F9844A)</option>
                        <option value="#F9C74F">Yellow (#F9C74F)</option>
                        <option value="#90BE6D">Green (#90BE6D)</option>
                        <option value="#43AA8B">Teal (#43AA8B)</option>
                        <option value="#4D908E">Blue Green (#4D908E)</option>
                        <option value="#577590">Blue Gray (#577590)</option>
                        <option value="#277DA1">Blue (#277DA1)</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="text" id="edit_embed_color" name="embed_color" style="display: none; flex: 1;">
                    <button type="button" id="edit_embed_color_picker" style="width: 40px; height: 38px; border: 2px solid var(--border-color); border-radius: 4px; cursor: pointer; padding: 0;"></button>
                </div>
                <label for="edit_embed_footer">Footer:</label>
                <input type="text" id="edit_embed_footer" name="embed_footer">
                <input type="hidden" id="edit_embed_author" name="embed_author">
                <label for="edit_embed_image_url">Image URL:</label>
                <input type="text" id="edit_embed_image_url" name="embed_image_url">
                <div class="thumbnail-container" style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                    <div class="thumbnail-selection" style="flex-grow: 1;">
                        <label for="edit_embed_thumbnail_url_select">Thumbnail:</label>
                        <select id="edit_embed_thumbnail_url_select" name="embed_thumbnail_url_select" class="thumbnail-select">
                            <option value="">None</option>
                            <option value="custom">Custom URL</option>
                        </select>
                        <div class="custom-thumbnail-container" style="display: none; margin-top: 10px;">
                            <label for="edit_embed_thumbnail_url">Custom Thumbnail URL:</label>
                            <input type="text" id="edit_embed_thumbnail_url" name="embed_thumbnail_url" class="custom-thumbnail-input">
                        </div>
                    </div>
                    <div class="thumbnail-preview-container">
                        <img id="edit-thumbnail-preview" class="thumbnail-preview" src="" alt="Thumbnail Preview" style="max-width: 75px; height: auto;">
                    </div>
                </div>
                <label for="edit_embed_mention_message">Mention Message:</label>
                <input type="text" id="edit_embed_mention_message" name="embed_mention_message">
            </div>

            <div class="modal-buttons">
                <button type="submit">Save</button>
                <button type="button" class="cancel-button">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Add New Event</h2>
        <form id="add-event-form">
            <input type="hidden" name="timezone" value="UTC">

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="add_message_type">Message Type:</label>
                    <select id="add_message_type" name="message_type">
                        <option value="plain">Plain Message</option>
                        <option value="embed" selected>Embed Message</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_channel_id">Channel:</label>
                    <select id="add_channel_id" name="channel_id" required>
                        <option value="1420123829484916867">üèÜÔΩúevents</option>
                        <option value="1420123824879308973">üêªÔΩúbear</option>
                        <option value="1420123828541198499">‚öîÔ∏èÔΩúarena</option>
                    </select>
                </div>
            </div>

            <div id="add-plain-message-fields">
                <label for="add_description">Description:</label>
                <input type="text" id="add_description" name="description">
            </div>

            <div class="form-row" style="align-items: flex-end;">
                <!-- Left half -->
                <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                    <div style="flex-basis: 46%;">
                        <label for="add_next_notification_date">Date (UTC):</label>
                        <input type="text" id="add_next_notification_date" name="next_notification_date" required placeholder="Select Date..." style="width: 100%;">
                    </div>
                    <div style="flex-basis: 23%;">
                        <label for="add_hour">Hour:</label>
                        <select id="add_hour" name="hour" style="width: 100%;"></select>
                    </div>
                    <div style="flex-basis: 23%;">
                        <label for="add_minute">Minute:</label>
                        <select id="add_minute" name="minute" style="width: 100%;"></select>
                    </div>
                </div>
                <!-- Right half -->
                <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">
                    <div style="flex-grow: 1;">
                        <label for="add_repeat_minutes">Repeat Interval:</label>
                        <select id="add_repeat_minutes" name="repeat_minutes" style="width: 100%;">
                            <option value="0">No Repeat</option>
                            <option value="fixed">Specific Days</option>
                            {% for i in range(1, 15) %}
                            <option value="{{ i * 1440 }}">{{ i }} Day(s)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="padding-bottom: 8px;">
                        <label for="add_is_enabled">Enabled:</label>
                        <input type="checkbox" id="add_is_enabled" name="is_enabled" value="true" checked>
                    </div>
                </div>
            </div>

            <div class="form-row form-row-split">
                <div class="form-group">
                    <label for="add_mention_type">Mention Type:</label>
                    <select id="add_mention_type" name="mention_type" required>
                        <option value="none" selected>None</option>
                        <option value="everyone">Everyone</option>
                        <option value="role_1420123834853490708">DOA Event üèÜ</option>
                        <option value="role_1420123831498178792">DOA Bear üêª</option>
                        <option value="role_1420839639136075796">doa Bear üêª</option>
                        <option value="role_1420839971400712213">doa Event üèÜ</option>
                        <option value="role_1420840300880068772">TFO Bear üêª</option>
                        <option value="role_1420840228209299519">TFO Event üèÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_notification_type">Notification Type:</label>
                    <select id="add_notification_type" name="notification_type">
                        <option value="1">30m, 10m, 5m, 0m</option>
                        <option value="2">10m, 5m, 0m</option>
                        <option value="3">5m, 0m</option>
                        <option value="4">5m</option>
                        <option value="5" selected>0m</option>
                        <option value="6">Custom Times</option>
                    </select>
                </div>
            </div>

            <div id="add-custom-times-container" style="display: none;">
                <label for="add_custom_times">Custom Times (e.g., 60-30-10-0):</label>
                <input type="text" id="add_custom_times" name="custom_times">
            </div>

            <div id="add-weekdays-container" style="display: none;">
                <label>Weekdays:</label>
                <div class="weekdays-checkboxes">
                    <input type="checkbox" name="weekdays" value="0"> Mon
                    <input type="checkbox" name="weekdays" value="1"> Tue
                    <input type="checkbox" name="weekdays" value="2"> Wed
                    <input type="checkbox" name="weekdays" value="3"> Thu
                    <input type="checkbox" name="weekdays" value="4"> Fri
                    <input type="checkbox" name="weekdays" value="5"> Sat
                    <input type="checkbox" name="weekdays" value="6"> Sun
                </div>
            </div>

            <div id="add-embed-fields" style="display: none;">
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
                <label for="add_embed_title">Title:</label>
                <input type="text" id="add_embed_title" name="embed_title">
                <label for="add_embed_description">Description:</label>
                <textarea id="add_embed_description" name="embed_description" rows="3"></textarea>
                <label for="add_embed_color">Color:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="add_embed_color_select" style="flex: 1;">
                        <option value="#F94144">Red (#F94144)</option>
                        <option value="#F3722C">Orange Red (#F3722C)</option>
                        <option value="#F8961E">Orange (#F8961E)</option>
                        <option value="#F9844A">Light Orange (#F9844A)</option>
                        <option value="#F9C74F">Yellow (#F9C74F)</option>
                        <option value="#90BE6D">Green (#90BE6D)</option>
                        <option value="#43AA8B">Teal (#43AA8B)</option>
                        <option value="#4D908E">Blue Green (#4D908E)</option>
                        <option value="#577590">Blue Gray (#577590)</option>
                        <option value="#277DA1">Blue (#277DA1)</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="text" id="add_embed_color" name="embed_color" style="display: none; flex: 1;">
                    <button type="button" id="add_embed_color_picker" style="width: 40px; height: 38px; border: 2px solid var(--border-color); border-radius: 4px; cursor: pointer; padding: 0;"></button>
                </div>
                <label for="add_embed_footer">Footer:</label>
                <input type="text" id="add_embed_footer" name="embed_footer" value="DOA Unified Notification System">
                <input type="hidden" id="add_embed_author" name="embed_author">
                <label for="add_embed_image_url">Image URL:</label>
                <input type="text" id="add_embed_image_url" name="embed_image_url">
                <div class="thumbnail-container" style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                    <div class="thumbnail-selection" style="flex-grow: 1;">
                        <label for="add_embed_thumbnail_url_select">Thumbnail:</label>
                        <select id="add_embed_thumbnail_url_select" name="embed_thumbnail_url_select" class="thumbnail-select">
                            <option value="">None</option>
                            <option value="custom">Custom URL</option>
                        </select>
                        <div class="custom-thumbnail-container" style="display: none; margin-top: 10px;">
                            <label for="add_embed_thumbnail_url">Custom Thumbnail URL:</label>
                            <input type="text" id="add_embed_thumbnail_url" name="embed_thumbnail_url" class="custom-thumbnail-input">
                        </div>
                    </div>
                    <div class="thumbnail-preview-container">
                        <img id="add-thumbnail-preview" class="thumbnail-preview" src="" alt="Thumbnail Preview" style="max-width: 75px; height: auto;">
                    </div>
                </div>
                <label for="add_embed_mention_message">Mention Message:</label>
                <input type="text" id="add_embed_mention_message" name="embed_mention_message">
            </div>

            <div class="modal-buttons">
                <button type="submit">Create</button>
                <button type="button" class="cancel-button">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-picker@2/dist/vanilla-picker.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    /* ===== VANILLA PICKER CONFIGURATION (WORKING) =====
     * Library: vanilla-picker v2
     * CDN CSS: https://cdn.jsdelivr.net/npm/vanilla-picker@2/dist/vanilla-picker.min.css
     * CDN JS: https://cdn.jsdelivr.net/npm/vanilla-picker@2/dist/vanilla-picker.min.js
     * HTML: <button type="button" id="xxx_color_picker"></button>
     * CSS: .picker_wrapper { z-index: 100000 !important; }
     * ================================================= */

    // Add dark mode CSS for color picker dynamically to match dashboard theme
    const isDarkMode = !document.body.classList.contains('light-mode');
    if (isDarkMode) {
        const style = document.createElement('style');
        style.textContent = `
            /* Match dashboard dark theme colors */
            .picker_wrapper.popup,
            .picker_wrapper.popup .picker_arrow::before,
            .picker_wrapper.popup .picker_arrow::after {
                background: #1e1e1e !important; /* var(--surface-color) */
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5) !important;
            }
            .picker_wrapper,
            .picker_wrapper * {
                border-color: #2c2c2c !important; /* var(--border-color) */
            }
            .picker_wrapper {
                border: 1px solid #2c2c2c !important;
            }
            .picker_wrapper .picker_slider,
            .picker_wrapper .picker_selector {
                background: #121212 !important; /* var(--background-color) */
                border: 1px solid #2c2c2c !important; /* var(--border-color) */
            }
            .picker_wrapper .picker_sample {
                border: 1px solid #2c2c2c !important;
            }
            /* Target all slider and selector indicators */
            .picker_selector .picker_sl,
            .picker_slider .picker_selector {
                border: 2px solid #2c2c2c !important; /* var(--border-color) */
            }
            /* Alpha slider */
            .picker_alpha {
                border: 1px solid #2c2c2c !important; /* var(--border-color) */
            }
            /* Hue slider */
            .picker_hue {
                border: 1px solid #2c2c2c !important; /* var(--border-color) */
            }
            /* Color selection area */
            .picker_sl {
                border: 1px solid #2c2c2c !important; /* var(--border-color) */
            }
            /* Editor area */
            .picker_editor {
                border: 1px solid #2c2c2c !important;
            }
            .picker_wrapper input,
            .picker_wrapper input[type="text"] {
                background: #121212 !important; /* var(--background-color) */
                border: 1px solid #2c2c2c !important; /* var(--border-color) */
                color: #e0e0e0 !important; /* var(--text-color) */
            }
            .picker_wrapper input:focus {
                border-color: #00a8ff !important; /* var(--primary-color) */
                border: 1px solid #00a8ff !important;
                outline: none !important;
            }
            .picker_wrapper button {
                background: #2a2a2a !important; /* var(--hover-color) */
                border: 1px solid #2c2c2c !important; /* var(--border-color) */
                color: #e0e0e0 !important; /* var(--text-color) */
            }
            .picker_wrapper button:hover {
                background: #00a8ff !important; /* var(--primary-color) */
                color: #ffffff !important; /* var(--header-color) */
            }
        `;
        document.head.appendChild(style);
    }

    // Load thumbnails dynamically from API
    const loadThumbnails = async () => {
        try {
            const response = await fetch('/api/thumbnails');
            const data = await response.json();

            // Get both thumbnail select elements
            const editSelect = document.getElementById('edit_embed_thumbnail_url_select');
            const addSelect = document.getElementById('add_embed_thumbnail_url_select');

            // Add thumbnails to both dropdowns
            data.thumbnails.forEach(thumbnail => {
                const editOption = document.createElement('option');
                editOption.value = thumbnail.url;
                editOption.textContent = thumbnail.filename;

                const addOption = document.createElement('option');
                addOption.value = thumbnail.url;
                addOption.textContent = thumbnail.filename;

                // Insert before "Custom URL" option
                editSelect.insertBefore(editOption, editSelect.querySelector('option[value="custom"]'));
                addSelect.insertBefore(addOption, addSelect.querySelector('option[value="custom"]'));
            });
        } catch (error) {
            console.error('Failed to load thumbnails:', error);
        }
    };

    // Load thumbnails on page load
    loadThumbnails();

    // Setup Vanilla Picker for color inputs with dropdown
    const setupColorPicker = (selectId, textInputId, buttonId, defaultColor = '#F94144') => {
        const select = document.getElementById(selectId);
        const textInput = document.getElementById(textInputId);
        const button = document.getElementById(buttonId);

        // Check if dark mode is active
        const isDarkMode = !document.body.classList.contains('light-mode');

        let picker = null;

        // Handle dropdown change
        select.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                // Show text input and enable color picker
                textInput.style.display = 'flex';
                button.style.pointerEvents = 'auto';
                button.style.opacity = '1';
                if (!picker) {
                    picker = new Picker({
                        parent: button,
                        popup: 'left',
                        alpha: false,
                        editor: true,
                        color: textInput.value || defaultColor,
                        onChange: function(color) {
                            const hexColor = color.hex.substring(0, 7);
                            textInput.value = hexColor;
                            button.style.backgroundColor = hexColor;
                        }
                    });
                }
                button.style.backgroundColor = textInput.value || defaultColor;
            } else {
                // Hide text input and disable color picker button
                textInput.style.display = 'none';
                textInput.value = e.target.value;
                button.style.backgroundColor = e.target.value;
                button.style.pointerEvents = 'none';
                button.style.opacity = '0.7';

                // Close picker if it's open
                if (picker && picker.settings.parent) {
                    const pickerPopup = document.querySelector('.picker_wrapper.popup');
                    if (pickerPopup) {
                        pickerPopup.classList.remove('open');
                    }
                }
            }
        });

        // Set initial button color based on current value
        const initialColor = textInput.value || defaultColor;
        button.style.backgroundColor = initialColor;

        // Set dropdown to match initial color or custom
        const matchingOption = Array.from(select.options).find(opt => opt.value === initialColor);
        if (matchingOption) {
            select.value = initialColor;
            // Disable picker button for preset colors
            button.style.pointerEvents = 'none';
            button.style.opacity = '0.7';
        } else {
            select.value = 'custom';
            textInput.style.display = 'flex';
            textInput.value = initialColor;
            // Enable picker button for custom colors
            button.style.pointerEvents = 'auto';
            button.style.opacity = '1';
        }
    };

    setupColorPicker('edit_embed_color_select', 'edit_embed_color', 'edit_embed_color_picker');
    setupColorPicker('add_embed_color_select', 'add_embed_color', 'add_embed_color_picker');

    const editModal = document.getElementById('edit-event-modal');
    const addModal = document.getElementById('add-event-modal');
    const addEventBtn = document.getElementById('add-event-btn');

    const setupModal = (modal) => {
        const closeButton = modal.querySelector('.close-button');
        const cancelButton = modal.querySelector('.cancel-button');
        const selects = modal.querySelectorAll('select');
        const thumbnailSelect = modal.querySelector('.thumbnail-select');
        const customThumbnailInput = modal.querySelector('.custom-thumbnail-input');
        const thumbnailPreview = modal.querySelector('.thumbnail-preview');
        const dateInput = modal.querySelector('input[name="next_notification_date"]');
        const hourPicker = modal.querySelector('[name="hour"]');
        const minutePicker = modal.querySelector('[name="minute"]');
        modal.picker = null; // To hold the litepicker instance

        // Populate hour picker
        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            hourPicker.add(new Option(hour, hour));
        }

        // Populate minute picker
        for (let i = 0; i < 60; i++) {
            const minute = i.toString().padStart(2, '0');
            minutePicker.add(new Option(minute, minute));
        }

        const initLitepicker = (defaultDate) => {
            setTimeout(() => {
                if (modal.style.display !== 'block') return;
                if (modal.picker) modal.picker.destroy();
                modal.picker = new Litepicker({
                    element: dateInput,
                    parentEl: document.body,
                    format: 'YYYY-MM-DD',
                    autoApply: true,
                    singleMode: true,
                    showTooltip: false,
                });

                modal.picker.on('show', () => {
                    if (!document.body.classList.contains('light-mode')) {
                        const pickerEl = document.querySelector('.litepicker');
                        if (pickerEl) {
                            const darkTheme = {
                                '--litepicker-container-months-color-bg': '#1e1e1e',
                                '--litepicker-container-months-box-shadow-color': '#000',
                                '--litepicker-footer-color-bg': '#1e1e1e',
                                '--litepicker-footer-box-shadow-color': '#000',
                                '--litepicker-tooltip-color-bg': '#1e1e1e',
                                '--litepicker-month-header-color': '#e0e0e0',
                                '--litepicker-button-prev-month-color': '#e0e0e0',
                                '--litepicker-button-next-month-color': '#e0e0e0',
                                '--litepicker-button-prev-month-color-hover': '#00a8ff',
                                '--litepicker-button-next-month-color-hover': '#00a8ff',
                                '--litepicker-month-weekday-color': '#e0e0e0',
                                '--litepicker-month-week-number-color': '#e0e0e0',
                                '--litepicker-day-color': '#e0e0e0',
                                '--litepicker-day-color-hover': '#fff',
                                '--litepicker-is-today-color': '#fff',
                                '--litepicker-is-in-range-color': '#2a2a2a',
                                '--litepicker-is-locked-color': '#4a4a4a',
                                '--litepicker-is-start-color': '#fff',
                                '--litepicker-is-start-color-bg': '#00a8ff',
                                '--litepicker-is-end-color': '#fff',
                                '--litepicker-is-end-color-bg': '#00a8ff',
                                '--litepicker-button-cancel-color': '#e0e0e0',
                                '--litepicker-button-cancel-color-bg': '#2c2c2c',
                                '--litepicker-button-apply-color': '#fff',
                                '--litepicker-button-apply-color-bg': '#00a8ff',
                                '--litepicker-button-reset-color': '#e0e0e0',
                                '--litepicker-button-reset-color-hover': '#00a8ff',
                                '--litepicker-highlighted-day-color': '#1e1e1e',
                                '--litepicker-highlighted-day-color-bg': '#00a8ff',
                            };
                            for (const [key, value] of Object.entries(darkTheme)) {
                                pickerEl.style.setProperty(key, value);
                            }
                        }
                    }
                });

                if (defaultDate) {
                    modal.picker.setDate(defaultDate);
                }
            }, 0);
        };
        modal.initLitepicker = initLitepicker;


        const closeModal = () => {
            modal.style.display = 'none';
            if (modal.picker) {
                modal.picker.destroy();
                modal.picker = null;
            }
        };

        closeButton.addEventListener('click', closeModal);
        cancelButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) closeModal();
        });

        const updateThumbnailPreview = () => {
            if (!thumbnailSelect) return;
            const selectedValue = thumbnailSelect.value;
            const customValue = customThumbnailInput ? customThumbnailInput.value.trim() : '';
            let previewUrl = '';

            if (selectedValue === 'custom') {
                previewUrl = customValue;
            } else if (selectedValue) {
                previewUrl = selectedValue;
            }

            if (previewUrl && thumbnailPreview) {
                thumbnailPreview.src = previewUrl;
                thumbnailPreview.style.display = 'block';
            } else if (thumbnailPreview) {
                thumbnailPreview.style.display = 'none';
            }
        };

        const toggleFields = () => {
            const messageTypeSelect = modal.querySelector('select[name="message_type"]');
            if (messageTypeSelect) {
                const plainFields = modal.querySelector('[id$="-plain-message-fields"]');
                const embedFields = modal.querySelector('[id$="-embed-fields"]');
                const isEmbed = messageTypeSelect.value === 'embed';
                plainFields.style.display = isEmbed ? 'none' : 'block';
                embedFields.style.display = isEmbed ? 'block' : 'none';
            }

            const repeatMinutesSelect = modal.querySelector('select[name="repeat_minutes"]');
            if (repeatMinutesSelect) {
                const weekdaysContainer = modal.querySelector('[id$="-weekdays-container"]');
                if (weekdaysContainer) weekdaysContainer.style.display = repeatMinutesSelect.value === 'fixed' ? 'block' : 'none';
            }

            const notificationTypeSelect = modal.querySelector('select[name="notification_type"]');
            if (notificationTypeSelect) {
                const customTimesContainer = modal.querySelector('[id$="-custom-times-container"]');
                if(customTimesContainer) customTimesContainer.style.display = notificationTypeSelect.value === '6' ? 'block' : 'none';
            }

            if (thumbnailSelect) {
                const customThumbnailContainer = modal.querySelector('.custom-thumbnail-container');
                if (customThumbnailContainer) customThumbnailContainer.style.display = thumbnailSelect.value === 'custom' ? 'block' : 'none';
                updateThumbnailPreview();
            }
        };

        selects.forEach(select => select.addEventListener('change', toggleFields));
        if (customThumbnailInput) {
            customThumbnailInput.addEventListener('input', updateThumbnailPreview);
        }

        modal.toggleFields = toggleFields;
    };

    setupModal(editModal);
    setupModal(addModal);

    addEventBtn.addEventListener('click', () => {
        const form = document.getElementById('add-event-form');
        form.reset();
        addModal.style.display = 'block';
        addModal.toggleFields();
        const now = new Date();
        form.querySelector('[name="hour"]').value = now.getUTCHours().toString().padStart(2, '0');
        form.querySelector('[name="minute"]').value = now.getUTCMinutes().toString().padStart(2, '0');
        addModal.initLitepicker(now);
    });

    document.querySelectorAll('.event').forEach(eventEl => {
        eventEl.addEventListener('click', () => {
            try {
                const rawEventData = eventEl.dataset.event;
                const eventData = JSON.parse(rawEventData);
                const form = document.getElementById('edit-event-form');

                // Populate main fields
                form.querySelector('#edit-event-id').value = eventData.id;
                form.querySelector('#edit_channel_id').value = eventData.channel_id;
                form.querySelector('#edit_repeat_minutes').value = eventData.repeat_minutes;
                form.querySelector('#edit_mention_type').value = eventData.mention_type;
                form.querySelector('#edit_notification_type').value = eventData.notification_type;
                form.querySelector('#edit_is_enabled').checked = eventData.is_enabled === 1;

                const nextNotification = new Date(eventData.next_notification);
                form.querySelector('[name="hour"]').value = nextNotification.getUTCHours().toString().padStart(2, '0');
                form.querySelector('[name="minute"]').value = nextNotification.getUTCMinutes().toString().padStart(2, '0');

                // Handle description and message type
                const messageTypeSelect = form.querySelector('#edit_message_type');
                let descriptionText = eventData.description || '';
                if (descriptionText.startsWith('CUSTOM_TIMES:')) {
                    const parts = descriptionText.split('|');
                    form.querySelector('#edit_custom_times').value = parts[0].replace('CUSTOM_TIMES:', '');
                    descriptionText = parts.length > 1 ? parts[1] : '';
                } else {
                    form.querySelector('#edit_custom_times').value = '';
                }

                if (descriptionText.startsWith('PLAIN_MESSAGE:')) {
                    messageTypeSelect.value = 'plain';
                    form.querySelector('#edit_description').value = descriptionText.replace('PLAIN_MESSAGE:', '');
                } else {
                    messageTypeSelect.value = 'embed';
                    form.querySelector('#edit_description').value = '';
                }

                // Populate embed fields
                const embed = eventData.embeds && eventData.embeds.length > 0 ? eventData.embeds[0] : {};
                form.querySelector('#edit_embed_title').value = embed.title || '';
                form.querySelector('#edit_embed_description').value = embed.description || '';
                const colorInput = form.querySelector('#edit_embed_color');
                const initialColor = embed.color ? `#${embed.color.toString(16).padStart(6, '0')}` : '#42445a';
                colorInput.value = initialColor;
                form.querySelector('#edit_embed_footer').value = embed.footer || '';
                form.querySelector('#edit_embed_author').value = embed.author || '';
                form.querySelector('#edit_embed_image_url').value = embed.image_url || '';
                form.querySelector('#edit_embed_mention_message').value = embed.mention_message || '';

                // Handle thumbnail
                const thumbnailSelect = form.querySelector('#edit_embed_thumbnail_url_select');
                const customThumbnailInput = form.querySelector('#edit_embed_thumbnail_url');
                const thumbnailUrl = embed.thumbnail_url || '';
                const isPreset = Array.from(thumbnailSelect.options).some(opt => opt.value === thumbnailUrl);

                if (isPreset) {
                    thumbnailSelect.value = thumbnailUrl;
                    if(customThumbnailInput) customThumbnailInput.value = '';
                } else if (thumbnailUrl) {
                    thumbnailSelect.value = 'custom';
                    if(customThumbnailInput) customThumbnailInput.value = thumbnailUrl;
                } else {
                    thumbnailSelect.value = '';
                    if(customThumbnailInput) customThumbnailInput.value = '';
                }

                // Handle weekdays
                const weekdays = eventData.notification_days ? eventData.notification_days.weekday.split('|').map(Number) : [];
                form.querySelectorAll('input[name="weekdays"]').forEach(checkbox => {
                    checkbox.checked = weekdays.includes(parseInt(checkbox.value));
                });
                
                editModal.style.display = 'block';
                editModal.toggleFields();
                editModal.initLitepicker(nextNotification);

            } catch (e) {
                console.error("Error parsing event data or displaying modal:", e);
            }
        });
    });

    const submitForm = async (form, url) => {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Handle thumbnail URL
        const thumbnailSelect = form.querySelector('.thumbnail-select');
        if (thumbnailSelect && thumbnailSelect.value !== 'custom') {
            data.embed_thumbnail_url = thumbnailSelect.value;
        }
        delete data.embed_thumbnail_url_select;

        // Validation and type conversion
        if (!data.channel_id) {
            alert("Error: Please select a channel for the event.");
            return;
        }

        if (data.next_notification_date && data.hour && data.minute) {
            const date = new Date(`${data.next_notification_date}T${data.hour}:${data.minute}:00Z`);
            data.hour = date.getUTCHours();
            data.minute = date.getUTCMinutes();
            data.next_notification = date.toISOString();
        }
        delete data.next_notification_date;

        if (data.id) data.id = parseInt(data.id);
        data.notification_type = parseInt(data.notification_type);
        data.is_enabled = form.querySelector('input[name="is_enabled"]').checked;

        if (data.repeat_minutes === 'fixed') {
            data.weekdays = Array.from(form.querySelectorAll('input[name="weekdays"]:checked')).map(cb => parseInt(cb.value));
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorText = await response.text();
                try {
                    const error = JSON.parse(errorText);
                    const errorMessage = error.detail ? JSON.stringify(error.detail) : 'Unknown error';
                    alert(`Failed to save event: ${errorMessage}`);
                } catch (e) {
                    alert(`Failed to save event: ${errorText}`);
                }
            }
        } catch (error) {
            alert(`Failed to save event: An unexpected error occurred.`);
            console.error('Submit error:', error);
        }
    };

    document.getElementById('edit-event-form').addEventListener('submit', (e) => {
        e.preventDefault();
        submitForm(e.target, '/update_event');
    });

    document.getElementById('add-event-form').addEventListener('submit', (e) => {
        e.preventDefault();
        submitForm(e.target, '/create_event');
    });
});
</script>
{% endblock %}