{% extends "base.html" %}

{% block title %}Data{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-4">Data & Analytics</h1>
<p class="mb-6">Comprehensive visualizations and analytics for Dawn of Ancients</p>

<div class="dashboard-section">
    <div id="allianceProgressChart" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="bearTrapChart" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="allianceAverageChart" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="furnaceDistributionChart" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="tcLevelHeatmap" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="furnace-level-hist" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="alliance-member-bar" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="bear-trap-damage-bar" style="width: 100%; height: 400px;"></div>
</div>

<div class="dashboard-section">
    <div id="player-activity-hist" style="width: 100%; height: 400px;"></div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    var graphData = {{ graph_json | safe }};
    var graphBearTrapData = {{ graph_bear_trap_json | safe }};
    var graphAvgData = {{ graph_avg_json | safe }};
    var graphHistData = {{ graph_hist_json | safe }};
    var graphHeatmapData = {{ graph_heatmap_json | safe }};
    var graphBarData = {{ graph_bar_json | safe }};
    var graphBearTrapTopData = {{ graph_bear_trap_top_json | safe }};
    var graphActivityData = {{ graph_activity_json | safe }};

    // Function to update chart theme
    function updateChartTheme() {
        const isLightMode = document.body.classList.contains('light-mode');

        const layoutUpdate = {
            template: isLightMode ? 'plotly_white' : 'plotly_dark',
            plot_bgcolor: isLightMode ? '#ffffff' : '#1e1e1e',
            paper_bgcolor: isLightMode ? '#ffffff' : '#1e1e1e',
            font: {
                color: isLightMode ? '#333333' : '#e0e0e0'
            }
        };

        Plotly.relayout('allianceProgressChart', layoutUpdate);
        Plotly.relayout('bearTrapChart', layoutUpdate);
        Plotly.relayout('allianceAverageChart', layoutUpdate);
        Plotly.relayout('furnaceDistributionChart', layoutUpdate);
        Plotly.relayout('tcLevelHeatmap', layoutUpdate);
        Plotly.relayout('furnace-level-hist', layoutUpdate);
        Plotly.relayout('alliance-member-bar', layoutUpdate);
        Plotly.relayout('bear-trap-damage-bar', layoutUpdate);
        Plotly.relayout('player-activity-hist', layoutUpdate);
    }

    // Wait for DOM to be ready and theme to be applied
    window.addEventListener('load', function() {
        // Plot all charts
        Plotly.newPlot('allianceProgressChart', graphData.data, graphData.layout, {responsive: true});
        Plotly.newPlot('bearTrapChart', graphBearTrapData.data, graphBearTrapData.layout, {responsive: true});
        Plotly.newPlot('allianceAverageChart', graphAvgData.data, graphAvgData.layout, {responsive: true});
        Plotly.newPlot('furnaceDistributionChart', graphHistData.data, graphHistData.layout, {responsive: true});
        Plotly.newPlot('tcLevelHeatmap', graphHeatmapData.data, graphHeatmapData.layout, {responsive: true});
        Plotly.newPlot('furnace-level-hist', graphHistData.data, graphHistData.layout, {responsive: true});
        Plotly.newPlot('alliance-member-bar', graphBarData.data, graphBarData.layout, {responsive: true});
        Plotly.newPlot('bear-trap-damage-bar', graphBearTrapTopData.data, graphBearTrapTopData.layout, {responsive: true});
        Plotly.newPlot('player-activity-hist', graphActivityData.data, graphActivityData.layout, {responsive: true});

        // Update theme immediately after plotting
        setTimeout(updateChartTheme, 100);

        // Listen for theme toggle
        const dataThemeToggle = document.getElementById('theme-toggle-button');
        if (dataThemeToggle) {
            dataThemeToggle.addEventListener('click', function() {
                // Wait a tiny bit for the body class to be updated
                setTimeout(updateChartTheme, 50);
            });
        }
    });
</script>
{% endblock %}
